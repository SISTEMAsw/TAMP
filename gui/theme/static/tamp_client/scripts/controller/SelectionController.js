(function(){"use strict";var a=this;a.require(["backbone","communicator","globals","app","models/SelectionModel","d3"],function(a,b,c,d,e){var f=a.Marionette.Controller.extend({model:new e.SelectionModel,initialize:function(a){var d=this.getAllSelections.bind(this);this.geoSelection=null,this.timeSelection=null,this.activeProducts=[],c.objects.add("color",d3.scale.category10()),this.model.set("selections",[]),this.colors=c.objects.get("color"),this.listenTo(b.mediator,"selection:changed",this.onSelectionChange),this.listenTo(b.mediator,"map:load:geojson",this.onLoadGeoJSON),this.listenTo(b.mediator,"map:layer:change",this.onChangeLayer),this.listenTo(b.mediator,"time:change",this.onTimeChange),b.reqres.setHandler("selections:get:all",d)},getAllSelections:function(){return{geo:this.geoSelection,time:this.timeSelection,actProd:this.activeProducts}},onSelectionChange:function(a){if(null!=a){var b=this.model.get("selections");b.push(a),this.model.set("selections",b)}else this.model.set("selections",[])},onTimeChange:function(a){this.timeSelection=a},onChangeLayer:function(a){if(console.log(a),!a.isBaseLayer){var b=c.products.find(function(b){return b.get("name")==a.name});if(b)if(a.visible)this.activeProducts.push(b.get("download").id);else{var d=this.activeProducts.indexOf(b.get("download").id);d>-1&&this.activeProducts.splice(d,1)}}},onLoadGeoJSON:function(a){var c,d=this.geojson.read(a);if(d){d.constructor!=Array&&(d=[d]);for(var e=0;e<d.length;++e){c?c.extend(d[e].geometry.getBounds()):c=d[e].geometry.getBounds(),b.mediator.trigger("selection:activated",!1);var f=this.colors(e);b.mediator.trigger("selection:changed",d[e],this._convertCoordsFromOpenLayers(d[e].geometry,0),f)}}},_convertCoordsFromOpenLayers:function(a,b){for(var c=a.getVertices(),d=[],e=0;e<c.length-1;++e){var f={x:c[e].x,y:c[e].y,z:b};d.push(f)}var f={x:c[e].x,y:c[e].y,z:b};return d.push(f),d}});return new f})}).call(this);