(function(){"use strict";var a=this;a.define(["backbone","communicator","hbs!tmpl/LayerSettings","underscore","plotty"],function(a,b,c){var d=a.Marionette.Layout.extend({template:{type:"handlebars",template:c},className:"panel panel-default optionscontrol not-selectable",colorscaletypes:_.keys(plotty.colorscales),initialize:function(a){this.selected=null,this.plot=new plotty.plot({colorScale:"jet",domain:[0,1]})},onShow:function(a){this.stopListening(b.mediator,"layer:settings:changed",this.onParameterChange),this.listenTo(b.mediator,"layer:settings:changed",this.onParameterChange),this.$(".panel-title").html('<h3 class="panel-title"><i class="fa fa-fw fa-sliders"></i> '+this.model.get("name")+" Settings</h3>"),this.$(".close").on("click",_.bind(this.onClose,this)),this.$el.draggable({containment:"#main",scroll:!1,handle:".panel-heading"});var c=this.model.get("parameters"),d=(this.model.get("height"),this.model.get("outlines"),this.model.get("views")[0].protocol),e=_.keys(c),f="",g=this;_.each(e,function(a){c[a].selected?(g.selected=a,f+='<option value="'+a+'" selected>'+c[a].name+"</option>"):f+='<option value="'+a+'">'+c[a].name+"</option>"}),this.$("#options").empty(),this.$("#options").append(f),c[this.selected].description&&this.$("#description").text(c[this.selected].description),c[g.selected].hasOwnProperty("logarithmic")&&this.addLogOption(c),this.$("#options").change(this.onOptionsChanged.bind(this)),this.$("#range_min").val(c[this.selected].range[0]),this.$("#range_max").val(c[this.selected].range[1]),this.$("#range_min_slider").attr("max",c[this.selected].range[1]),this.$("#range_min_slider").attr("min",c[this.selected].range[0]),this.$("#range_min_slider").attr("value",c[this.selected].range[0]),this.$("#range_max_slider").attr("max",c[this.selected].range[1]),this.$("#range_max_slider").attr("min",c[this.selected].range[0]),this.$("#range_max_slider").attr("value",c[this.selected].range[1]),this.$("#opacitysilder").val(100*this.model.attributes.opacity),this.$("#opacitysilder").on("input change",function(){var a=Number(this.value)/100;g.model.set("opacity",a),b.mediator.trigger("productCollection:updateOpacity",{model:g.model,value:a})}),this.$("#clamp_min").on("input change",function(a){var c=g.model.get("parameters");c[g.selected].clamp_min=$("#clamp_min").prop("checked"),g.model.set("parameters",c),b.mediator.trigger("layer:parameters:changed",g.model.get("name"))}),this.$("#clamp_max").on("input change",function(a){var c=g.model.get("parameters");c[g.selected].clamp_max=$("#clamp_max").prop("checked"),g.model.set("parameters",c),b.mediator.trigger("layer:parameters:changed",g.model.get("name"))});var h=Math.abs(c[this.selected].range[1]-c[this.selected].range[0])/120;this.$("#range_min_slider").attr("step",h),this.$("#range_max_slider").attr("step",h),this.$("#range_min_slider").on("input change",function(){var a=[parseFloat(this.value),c[g.selected].range[1]];c[g.selected].range=a,b.mediator.trigger("layer:range:changed",g.model.get("name"),a,c[g.selected].colorscale),g.updateRange(c)}),this.$("#range_max_slider").on("input change",function(){var a=[c[g.selected].range[0],parseFloat(this.value)];c[g.selected].range=a,b.mediator.trigger("layer:range:changed",g.model.get("name"),a,c[g.selected].colorscale),g.updateRange(c)}),this.registerKeyEvents(this.$("#range_min")),this.registerKeyEvents(this.$("#range_max"));var i,j="";_.each(this.colorscaletypes,function(a){c[g.selected].colorscale==a?(i=a,j+='<option value="'+a+'" selected>'+a+"</option>"):j+='<option value="'+a+'">'+a+"</option>"}),this.$("#style").empty(),this.$("#style").append(j),this.$("#style").change(function(a){var d=$(a.target).find("option:selected").text();i=d,g.$("#gradient").attr("class",i),c[g.selected].colorscale=d,g.updateRange(c),b.mediator.trigger("layer:parameters:changed",g.model.get("name"))}),"undefined"!=typeof this.model.get("coefficients_range")&&(this.$("#coefficients_range").empty(),this.$("#coefficients_range").append('<li style="margin-top: 5px;"><label for="coefficients_range_min" style="width: 120px;">Coefficients range: </label><input id="coefficients_range_min" type="text" style="width:30px;"/><input id="coefficients_range_max" type="text" style="width:30px; margin-left:8px"/></li><p style="font-size:0.85em; margin-left:130px;"> [-1,-1]: No range limitation</p>'),this.$("#coefficients_range_min").val(this.model.get("coefficients_range")[0]),this.$("#coefficients_range_max").val(this.model.get("coefficients_range")[1]),this.registerKeyEvents(this.$("#coefficients_range_min")),this.registerKeyEvents(this.$("#coefficients_range_max"))),"WPS"==d&&(this.$("#shc").empty(),this.$("#shc").append('<p>Spherical Harmonics Coefficients</p><div class="myfileupload-buttonbar "><label class="btn btn-default shcbutton"><span><i class="fa fa-fw fa-upload"></i> Upload SHC File</span><input id="upload-selection" type="file" accept=".shc" name="files[]" /></label></div>'),this.$("#upload-selection").change(this.onUploadSelectionChanged.bind(this)),this.model.get("shc_name")&&g.$("#shc").append('<p id="filename" style="font-size:.9em;">Selected File: '+this.model.get("shc_name")+"</p>")),g.updateRange(c),this.createHeightTextbox(this.model.get("height"))},onClose:function(){this.close()},updateRange:function(a){this.model.set("parameters",a),a[this.selected].hasOwnProperty("logarithmic")?this.createScale(a[this.selected].logarithmic):this.createScale()},onParameterChange:function(){this.onShow()},onOptionsChanged:function(){var a=this.model.get("parameters");delete a[this.selected].selected,this.selected=$("#options").find("option:selected").val(),this.$("#style").empty();var c,d="";_.each(this.colorscaletypes,function(b){a[this.selected].colorscale==b?(c=b,d+='<option value="'+b+'" selected>'+b+"</option>"):d+='<option value="'+b+'">'+b+"</option>"},this),this.$("#style").append(d),this.$("#range_min").val(a[this.selected].range[0]),this.$("#range_max").val(a[this.selected].range[1]),a[this.selected].hasOwnProperty("logarithmic")?this.addLogOption(a):this.$("#logarithmic").empty(),a[this.selected].selected=!0,a[this.selected].description&&this.$("#description").text(a[this.selected].description),this.createHeightTextbox(this.model.get("height")),this.model.set("parameters",a),b.mediator.trigger("layer:parameters:changed",this.model.get("name"))},registerKeyEvents:function(a){var b=this;a.keypress(function(a){13==a.keyCode?(a.preventDefault(),b.applyChanges()):b.createApplyButton()}),a.keyup(function(a){8==a.keyCode&&b.createApplyButton()}),a.click(function(){$(this).select()})},createApplyButton:function(){var a=this;0==$("#changesbutton").length&&($("#applychanges").append('<button type="button" class="btn btn-default" id="changesbutton" style="width: 100%;"> Apply changes </button>'),$("#changesbutton").click(function(b){a.applyChanges()}))},applyChanges:function(){var a=this.model.get("parameters"),c=!1,d=parseFloat($("#range_min").val());c=c||this.checkValue(d,$("#range_min"));var e=parseFloat($("#range_max").val());if(c=c||this.checkValue(e,$("#range_max")),c||(a[this.selected].range=[d,e],a[this.selected].hasOwnProperty("logarithmic")?this.createScale(a[this.selected].logarithmic):this.createScale()),$("#coefficients_range_min").length&&$("#coefficients_range_max").length){var f=parseFloat($("#coefficients_range_min").val());c=c||this.checkValue(f,$("#coefficients_range_min"));var g=parseFloat($("#coefficients_range_max").val());c=c||this.checkValue(g,$("#coefficients_range_max")),c||this.model.set("coefficients_range",[f,g])}if($("#heightvalue").length){var h=parseFloat($("#heightvalue").val());c=c||this.checkValue(h,$("#heightvalue")),c||this.model.set("height",h)}c||($("#applychanges").empty(),this.model.set("parameters",a),b.mediator.trigger("layer:parameters:changed",this.model.get("name")))},checkValue:function(a,b){return isNaN(a)?(b.addClass("text_error"),!0):(b.removeClass("text_error"),!1)},setModel:function(a){this.model=a},sameModel:function(a){return this.model.get("name")==a.get("name")},onUploadSelectionChanged:function(a){var c=this,d=new FileReader,e=a.target.files[0].name;d.onloadend=function(a){c.model.set("shc",a.target.result),c.model.set("shc_name",e),c.$("#shc").find("#filename").remove(),c.$("#shc").append('<p id="filename" style="font-size:.9em;">Selected File: '+e+"</p>"),b.mediator.trigger("file:shc:loaded",a.target.result);var d={name:c.model.get("name"),isBaseLayer:!1,visible:!1};b.mediator.trigger("map:layer:change",d),b.mediator.trigger("layer:activate",c.model.get("views")[0].id)},d.readAsText(a.target.files[0])},addLogOption:function(a){var c=this;if(a[this.selected].hasOwnProperty("logarithmic")){var d="";a[this.selected].logarithmic&&(d="checked"),this.$("#logarithmic").empty(),this.$("#logarithmic").append('<form style="vertical-align: middle;"><label for="outlines" style="width: 100px;">Log. Scale: </label><input type="checkbox" name="logarithmic" value="logarithmic" '+d+"></input></form>"),this.$("#logarithmic input").change(function(a){var d=c.model.get("parameters");d[c.selected].logarithmic=!d[c.selected].logarithmic,c.model.set("parameters",d),b.mediator.trigger("layer:parameters:changed",c.model.get("name")),d[c.selected].hasOwnProperty("logarithmic")?c.createScale(d[c.selected].logarithmic):c.createScale()})}},createScale:function(a){var b="⁰¹²³⁴⁵⁶⁷⁸⁹",c=function(a){return a>=0?(a+"").split("").map(function(a){return b[a]}).join(""):0>a?"⁻"+(a+"").split("").map(function(a){return b[a]}).join(""):void 0};$("#setting_colorscale").empty();var d=20,e=$("#setting_colorscale").width(),f=e-2*d,g=this.model.get("parameters")[this.selected].range[0],h=this.model.get("parameters")[this.selected].range[1],i=this.model.get("parameters")[this.selected].uom,j=this.model.get("parameters")[this.selected].colorscale;this.plot.setColorScale(j),$("#setting_colorscale").append('<div id="scaleimagecontainer" style="width:'+f+"px; height:20px; margin-left:"+d+'px"></div>');var k=this.plot.getColorScaleImage();k.className="scaleimage",$("#scaleimagecontainer").append(k);var l,m=d3.select("#setting_colorscale").append("svg").attr("width",e).attr("height",40);a?(l=d3.scale.log(),0==g&&(g=.001)):l=d3.scale.linear(),l.domain([g,h]),l.range([0,f]);var n=d3.svg.axis().scale(l).ticks(8,function(a){return 10+c(Math.round(Math.log(a)/Math.LN10))});n.tickValues(l.ticks(3).concat(l.domain())),n.tickFormat(d3.format(".3g"));var o=m.append("g").attr("class","x axis").attr("transform","translate("+[d,3]+")").call(n);i&&o.append("text").style("text-anchor","middle").style("font-size","1.1em").attr("transform","translate("+[f/2,35]+")").text(i),m.selectAll(".tick").select("line").attr("stroke","black")},createHeightTextbox:function(a){this.$("#height").empty(),!a&&0!=a||"Fieldlines"==this.selected||(this.$("#height").append('<form style="vertical-align: middle;"><label for="heightvalue" style="width: 70px;">Height: </label><input id="heightvalue" type="text" style="width:30px; margin-left:8px"/></form>'),this.$("#heightvalue").val(a),this.$("#height").append('<p style="font-size:0.85em; margin-left: 70px;">Above ellipsoid (Km)</p>'),this.registerKeyEvents(this.$("#heightvalue")))}});return{LayerSettings:d}})}).call(this);