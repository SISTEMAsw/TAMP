(function(){"use strict";var a=this;a.define(["backbone","communicator","globals","underscore"],function(a,b,c){var d=a.Marionette.ItemView.extend({tagName:"article",id:"story",events:{},initialize:function(a){},onShow:function(a){$("#storyView").css({display:"block",visibility:"visible"}),$("#story").bind("scroll",this.onScroll.bind(this)),$(".close").bind("click",this.onClose.bind(this)),this.sections=$("section"),_(this.sections).each(function(a){a.wasActive=!1}),this.setActive(0)},onScroll:function(a){var b=document.getElementById("story"),c=b.scrollTop,d=b.offsetHeight;if(0===c)return this.setActive(0);var e=0,f=.2*d,g=_(this.sections).any(function(a,b){return e+=a.offsetHeight,e-f>c?this.setActive(b):!1},this);g||this.setActive(this.sections.length-1)},setActive:function(a){if(document.getElementById("story").dataset.active==a)return!0;if(document.getElementById("story").dataset.active=a,_(this.sections).each(function(a){a.className=a.className.replace(" active","")}),this.sections[a].className+=" active",document.body.className="section-"+a,!this.sections[a].wasActive){this.sections[a].hasAttribute("data-reset")&&b.mediator.trigger("app:reset");var d=!1;if(this.sections[a].hasAttribute("data-zoom")){d=!0;var e=this.sections[a].getAttribute("data-zoom");b.mediator.trigger("map:change:zoom",e)}var f={},g=!1;if(this.sections[a].hasAttribute("data-longitude")&&(f.lon=this.sections[a].getAttribute("data-longitude"),g=!0),this.sections[a].hasAttribute("data-latitude")&&(f.lat=this.sections[a].getAttribute("data-latitude"),g=!0),d&&g&&b.mediator.trigger("map:center",{x:f.lon,y:f.lat,l:e}),this.sections[a].hasAttribute("data-events")){var h=this.sections[a].getAttribute("data-events").split(";");_.each(h,function(a){b.mediator.trigger(a)},this)}if(this.sections[a].hasAttribute("data-yAxis")){var i=this.sections[a].getAttribute("data-yAxis").split(",");b.mediator.trigger("change:axis:parameters",i)}if(this.sections[a].hasAttribute("data-time")){var j=this.sections[a].getAttribute("data-time").split("/"),k={};k.start=new Date(j[0]),k.end=new Date(j[1]),b.mediator.trigger("date:selection:change",k)}if(this.sections[a].hasAttribute("data-parameter")){var l=this.sections[a].getAttribute("data-parameter").split(";");_.each(l,function(a){a=a.split(":");var d,e=_.find(c.products.models,function(b){return b.get("views")[0].id==a[0]}),f=e.get("parameters");if(_.each(_.keys(f),function(a){f[a].selected&&(d=a)}),4==a.length)switch(a[2]){case"range":var g=a[3].split(",");g=[parseFloat(g[0]),parseFloat(g[1])],f[a[1]].range=g;break;case"height":e.set("height",parseFloat(a[3]));break;case"coefficients_range":var h=a[3].split(",");h=[parseFloat(h[0]),parseFloat(h[1])],e.set("coefficients_range",h)}e.set("parameters",f),b.mediator.trigger("layer:parameters:changed",e.get("name")),b.mediator.trigger("layer:settings:changed",e.get("name"))},this)}if(this.sections[a].hasAttribute("data-set-parameter")){var m,n=this.sections[a].getAttribute("data-set-parameter").split(":"),o=_.find(c.products.models,function(a){return a.get("views")[0].id==n[0]}),p=o.get("parameters");_.each(_.keys(p),function(a){p[a].selected&&(m=a)}),m&&m!=n[1]?(delete p[m].selected,p[n[1]].selected=!0):p[n[1]].selected=!0,b.mediator.trigger("layer:parameters:changed",o.get("name")),b.mediator.trigger("layer:settings:changed",o.get("name"))}if(this.sections[a].hasAttribute("data-settings")&&b.mediator.trigger("layer:open:settings",this.sections[a].getAttribute("data-settings")),this.sections[a].hasAttribute("data-layers")){var q=this.sections[a].getAttribute("data-layers").split(";");_.each(q,function(a){b.mediator.trigger("layer:activate",a)},this)}if(this.sections[a].hasAttribute("data-tl")&&b.mediator.trigger("region:show:view","tl",this.sections[a].getAttribute("data-tl")),this.sections[a].hasAttribute("data-tr")&&b.mediator.trigger("region:show:view","tr",this.sections[a].getAttribute("data-tr")),this.sections[a].hasAttribute("data-bl")&&b.mediator.trigger("region:show:view","bl",this.sections[a].getAttribute("data-bl")),this.sections[a].hasAttribute("data-br")&&b.mediator.trigger("region:show:view","br",this.sections[a].getAttribute("data-br")),this.sections[a].hasAttribute("data-selection")&&$.get(this.sections[a].getAttribute("data-selection"),function(a){b.mediator.trigger("map:load:geojson",a)}),this.sections[a].hasAttribute("data-bbox")){var r=this.sections[a].getAttribute("data-bbox").split(","),s={n:r[3],e:r[2],s:r[1],w:r[0]};b.mediator.trigger("selection:changed",s)}this.sections[a].wasActive=!0}return!0},onClose:function(){$("#storyView").css({display:"none",visibility:"hidden"}),this.close()}});return{StoryBannerView:d}})}).call(this);