(function(){"use strict";var a=this;a.define(["backbone","communicator","timeslider","timeslider_plugins","globals","underscore","d3"],function(a,b,c,d,e){var f=a.Marionette.ItemView.extend({id:"timeslider",events:{selectionChanged:"onChangeTime",coverageselected:"onCoverageSelected"},initialize:function(a){this.options=a},render:function(a){},onShow:function(a){this.listenTo(b.mediator,"map:layer:change",this.changeLayer),this.listenTo(b.mediator,"map:position:change",this.updateExtent),this.listenTo(b.mediator,"date:selection:change",this.onDateSelectionChange),this.listenTo(b.mediator,"date:tick:select",this.onTickSelected),b.reqres.setHandler("get:time",this.returnTime),this.csrftoken=!1;var c="csrftoken";if(document.cookie&&""!=document.cookie)for(var d=document.cookie.split(";"),e=0;e<d.length;e++){var f=jQuery.trim(d[e]);if(f.substring(0,c.length+1)==c+"="){this.csrftoken=decodeURIComponent(f.substring(c.length+1));break}}var g=new Date(this.options.brush.start),h=new Date(this.options.brush.end);this.activeWPSproducts=[];var i={domain:{start:new Date(this.options.domain.start),end:new Date(this.options.domain.end)},brush:{start:g,end:h},debounce:300,ticksize:8,datasets:[]};this.options.display&&(i.display={start:new Date(this.options.display.start),end:new Date(this.options.display.end)}),this.slider=new TimeSlider(this.el,i),this.slider.setBrushTooltip(!0),this.slider.setBrushTooltipOffset([-30,this.el.parentElement.parentElement.offsetHeight-2*this.el.parentElement.offsetHeight-50]),b.mediator.trigger("time:change",{start:g,end:h}),b.mediator.timeOfInterest={start:g,end:h}},onChangeTime:function(a){b.mediator.trigger("time:change",a.originalEvent.detail),b.mediator.timeOfInterest={start:a.originalEvent.detail.start,end:a.originalEvent.detail.end}},onDateSelectionChange:function(a){this.slider.select(a.start,a.end)},onTickSelected:function(a){this.slider.setTimetick(a)},changeLayer:function(a){if(!a.isBaseLayer){var c=e.products.find(function(b){return b.get("name")==a.name});if(c)if(a.visible&&c.get("timeSlider"))switch(c.get("timeSliderProtocol")){case"WMS":this.slider.addDataset({id:c.get("view").id,color:c.get("color"),data:new TimeSlider.Plugin.WMS({url:c.get("view").urls[0],eoid:c.get("view").id,dataset:c.get("view").id})});break;case"EOWCS":this.slider.addDataset({id:c.get("download").id,color:c.get("color"),data:new TimeSlider.Plugin.EOWCS({url:c.get("download").url,eoid:c.get("download").id,dataset:c.get("download").id})});break;case"WPS":var d=b.reqres.request("map:get:extent");this.slider.addDataset({id:c.get("download").id,color:c.get("color"),data:new TimeSlider.Plugin.WPS({url:c.get("download").url,eoid:c.get("download").id,dataset:c.get("download").id,bbox:[d.left,d.bottom,d.right,d.top]})}),this.activeWPSproducts.push(c.get("download").id),this.slider.updateBBox([d.left,d.bottom,d.right,d.top],c.get("download").id);break;case"INDEX":var f={id:c.get("download").id,color:c.get("color"),lineplot:!0,data:new TimeSlider.Plugin.WPS({url:c.get("download").url,eoid:c.get("download").id,dataset:c.get("download").id,indices:!0,processid:"get_indices",collectionid:"index_id",output:"output"})};this.slider.addDataset(f)}else this.slider.removeDataset(c.get("download").id),-1!=this.activeWPSproducts.indexOf(c.get("download").id)&&this.activeWPSproducts.splice(this.activeWPSproducts.indexOf(c.get("download").id),1)}},returnTime:function(){return b.mediator.timeOfInterest},updateExtent:function(a){for(var b=0;b<this.activeWPSproducts.length;b++)this.slider.updateBBox([a.left,a.bottom,a.right,a.top],this.activeWPSproducts[b])},onCoverageSelected:function(a){if(a.originalEvent.detail.bbox){var c=a.originalEvent.detail.bbox.replace(/[()]/g,"").split(",").map(parseFloat);this.slider.select(a.originalEvent.detail.start,a.originalEvent.detail.end),b.mediator.trigger("map:set:extent",c)}}});return{TimeSliderView:f}})}).call(this);