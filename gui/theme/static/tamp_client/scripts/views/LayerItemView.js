(function(){"use strict";var a=this;a.define(["backbone","communicator","views/AuthView","models/AuthModel","hbs!tmpl/BulletLayer","hbs!tmpl/iFrame","globals","app","underscore"],function(a,b,c,d,e,f,g,h){var i=a.Marionette.ItemView.extend({tagName:"li",events:{drop:"drop",change:"onChange","click .fa-adjust":"onOpenSlider","slide .ui-slider":"onOpacityAdjust"},initialize:function(a){this.$slider=$("<div>").slider({range:"max",max:100,min:0}),this.$slider.width(100),this.authview=null},onShow:function(a){this.listenTo(b.mediator,"layer:activate",this.layerActivate),$(".sortable").sortable({revert:!0,delay:90,containment:".layercontrol .panel-body",axis:"y",forceHelperSize:!0,forcePlaceHolderSize:!0,placeholder:"sortable-placeholder",handle:".fa-sort",start:function(a,b){$(".ui-slider").detach(),$(".fa-adjust").toggleClass("active"),$(".fa-adjust").popover("hide")},stop:function(a,b){b.item.trigger("drop",b.item.index())}}),$(".fa-adjust").popover({trigger:"manual"});var c=this;this.$el.has(".fa-sliders").length&&this.$el.find(".fa-sliders").click(function(){_.isUndefined(h.layerSettings.isClosed)||h.layerSettings.isClosed?(h.layerSettings.setModel(c.model),h.optionsBar.show(h.layerSettings)):h.layerSettings.sameModel(c.model)?h.optionsBar.close():(h.layerSettings.setModel(c.model),h.optionsBar.show(h.layerSettings))})},onChange:function(a){var e=!1;this.model.get("view").isBaseLayer&&(e=!0);var i={name:this.model.get("name"),isBaseLayer:e,visible:a.target.checked};if(!e&&a.target.checked){var j=g.products.find(function(a){return a.get("name")==i.name});if(-1!=j&&"undefined"!=typeof j){i.visible?this.model.set("visible",!0):this.model.set("visible",!1);var k=j.get("views")[0].urls[0]+"?";if(k.indexOf("https")>-1){var j=j.get("views")[0].id,l="LAYERS="+j+"&TRANSPARENT=true&FORMAT=image%2Fpng&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&STYLES=&SRS=EPSG%3A4326";l+="&BBOX=33.75,56.25,33.80,56.50&WIDTH=2&HEIGHT=2",l=k+l,$.ajax({url:l,type:"GET",suppressErrors:!0,xhrFields:{withCredentials:!0},success:function(a,c,d){b.mediator.trigger("map:layer:change",i)},error:function(a,e,g){403==a.status?$("#error-messages").append('<div class="alert alert-warning alert-danger"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>Warning!</strong> You are not authorized to access this product</div>'):(this.authview=new c.AuthView({model:new d.AuthModel({url:l}),template:f,layerprop:i}),b.mediator.trigger("progress:change",!1),h.optionsBar.show(this.authview))}})}else if("WPS"==this.model.get("views")[0].protocol)if(this.model.get("shc"))b.mediator.trigger("map:layer:change",i);else{_.isUndefined(h.layerSettings.isClosed)||h.layerSettings.isClosed?(h.layerSettings.setModel(this.model),h.optionsBar.show(h.layerSettings)):h.layerSettings.sameModel(this.model)?h.optionsBar.close():(h.layerSettings.setModel(this.model),h.optionsBar.show(h.layerSettings)),$("#error-messages").append('<div class="alert alert-info"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>Please click on Upload SHC and select a spherical harmonics coefficients file before activating this layer</div>');var m=$("input[type$='checkbox']",this.$el);m.prop("checked",!1)}else b.mediator.trigger("map:layer:change",i)}else"undefined"==typeof j&&b.mediator.trigger("map:layer:change",i)}else a.target.checked?e&&a.target.checked&&b.mediator.trigger("map:layer:change",i):b.mediator.trigger("map:layer:change",i)},drop:function(a,c){b.mediator.trigger("productCollection:updateSort",{model:this.model,position:c})},onOpenSlider:function(a){this.$(".fa-adjust").toggleClass("active").hasClass("active")?(this.$(".fa-adjust").popover("show"),this.$(".popover-content").empty().append(this.$slider),this.$(".ui-slider").slider("option","value",100*this.model.get("opacity"))):(this.$slider.detach(),this.$(".fa-adjust").popover("hide"))},onOpacityAdjust:function(a,c){this.model.set("opacity",c.value/100),b.mediator.trigger("productCollection:updateOpacity",{model:this.model,value:c.value/100})},layerActivate:function(a){if(this.model.get("views")&&this.model.get("views")[0].id==a){var b=$("input[type$='checkbox']",this.$el);b.prop("checked",!0)}},onRender:function(){"Digital Elevation Model"==this.model.get("name")&&this.$el.empty()}});return{LayerItemView:i}})}).call(this);