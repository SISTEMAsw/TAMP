(function(){"use strict";var a=this;a.define(["backbone","communicator","globals","models/DownloadModel","hbs!tmpl/Download","hbs!tmpl/SelectCoverageListItem","hbs!tmpl/CoverageInfo","hbs!tmpl/CoverageDownloadPost","underscore"],function(a,b,c,d,e,f,g,h){var i=a.Collection.extend({fetch:function(b){return b||(b={}),b.dataType="xml",a.Collection.prototype.fetch.call(this,b)},parse:function(a){return WCS.Core.Parse.parse(a).coverageDescriptions}}),j=a.Marionette.ItemView.extend({tagName:"div",id:"modal-start-download",className:"panel panel-default download",template:{type:"handlebars",template:e},modelEvents:{reset:"onCoveragesReset"},events:{"click #btn-select-all-coverages":"onSelectAllCoveragesClicked","click #btn-invert-coverage-selection":"onInvertCoverageSelectionClicked",'change input[type="checkbox"]':"onCoverageSelected","click #btn-start-download":"onStartDownloadClicked"},initialize:function(b){this.coverages=new a.Collection([])},onShow:function(a){this.listenTo(this.coverages,"reset",this.onCoveragesReset),this.$(".close").on("click",_.bind(this.onClose,this)),this.$el.draggable({containment:"#content",scroll:!1,handle:".panel-heading"});var b=this.$("#download-list");b.children().remove();var c=_.map(this.model.get("products"),function(a,b){var c=new i([]),d={};return a.get("timeSlider")&&(d={subsetTime:[getISODateTimeString(this.model.get("ToI").start),getISODateTimeString(this.model.get("ToI").end)]}),c.url=WCS.EO.KVP.describeEOCoverageSetURL(a.get("download").url,b,d),c},this),d=_.invoke(c,"fetch");$.when.apply($,d).done(_.bind(function(){_.each(c,function(a){a.each(function(b){b.set("url",a.url)})});var a=_.flatten(_.pluck(c,"models"));this.coverages.reset(a)},this))},onSelectAllCoveragesClicked:function(){this.$('input[type="checkbox"]').prop("checked",!0).trigger("change")},onInvertCoverageSelectionClicked:function(){this.$('input[type="checkbox"]').each(function(){var a=$(this);a.prop("checked",!a.is(":checked")).trigger("change")})},onCoveragesReset:function(){var a=this.$("#download-list");this.coverages.each(function(b){var c=b.toJSON(),d=$(f(c));a.append(d),d.find("i").popover({trigger:"hover",html:!0,content:g(c),title:"Coverage Description",placement:"right"})},this)},onCoverageSelected:function(){this.$("input:checked").length?this.$("#btn-start-download").removeAttr("disabled"):this.$("#btn-start-download").attr("disabled","disabled")},onStartDownloadClicked:function(){var a=$("#div-downloads"),b={};b.format=this.$("#select-output-format").val(),this.$('input[type="checkbox"]').each(_.bind(function(c){if($('input[type="checkbox"]')[c].checked){var d=this.coverages.models[c],e=getCoverageXML(d.get("coverageId"),b),f=d.get("url").split("?")[0]+"?",g=$(h({url:f,xml:e}));a.append(g),_.delay(function(){g.submit()},1e3*c)}},this))},onClose:function(){b.mediator.trigger("ui:close","download"),this.close()}});return{DownloadView:j}})}).call(this);