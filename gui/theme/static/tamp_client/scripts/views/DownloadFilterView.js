(function(){"use strict";var a=this;a.define(["backbone","communicator","globals","models/DownloadModel","hbs!tmpl/DownloadFilter","hbs!tmpl/FilterTemplate","hbs!tmpl/wps_retrieve_data_filtered","hbs!tmpl/CoverageDownloadPost","underscore"],function(a,b,c,d,e,f,g,h){var i=a.Marionette.ItemView.extend({tagName:"div",id:"modal-start-download",className:"panel panel-default download",template:{type:"handlebars",template:e},initialize:function(b){this.coverages=new a.Collection([]),this.start_picker=null,this.end_picker=null,this.models=[],this.swarm_prod=[],this.loadcounter=0},onShow:function(a){this.listenTo(this.coverages,"reset",this.onCoveragesReset),this.$(".close").on("click",_.bind(this.onClose,this)),this.$el.draggable({containment:"#content",scroll:!1,handle:".panel-heading"}),this.$("#btn-start-download").on("click",_.bind(this.onStartDownloadClicked,this));var b=this.model.get("filter"),c=this.model.get("AoI");c&&("undefined"==typeof b&&(b={}),b.Longitude=[c.w,c.e],b.Latitude=[c.s,c.n]),$.isEmptyObject(b)||this.renderFilterList(b),this.$(".delete-filter").click(function(a){this.parentElement.parentElement.remove()});var d;this.models=[],this.swarm_prod=[],$.datepicker.setDefaults({showOn:"both",dateFormat:"dd.mm.yy"});var e=this,f=this.model.get("ToI");this.start_picker=this.$("#starttime").datepicker({onSelect:function(){var a=e.start_picker.datepicker("getDate"),b=e.end_picker.datepicker("getDate"),c=Math.floor((b-a)/864e5);c>15?(b=new Date(a),b.setDate(b.getDate()+15),e.end_picker.datepicker("setDate",b)):0>c&&e.start_picker.datepicker("setDate",b)}}),this.start_picker.datepicker("setDate",f.start),this.end_picker=this.$("#endtime").datepicker({onSelect:function(){var a=e.start_picker.datepicker("getDate"),b=e.end_picker.datepicker("getDate"),c=Math.floor((b-a)/864e5);c>15?(a=new Date(b),a.setDate(a.getDate()-15),e.start_picker.datepicker("setDate",a)):0>c&&e.end_picker.datepicker("setDate",a)}}),this.end_picker.datepicker("setDate",f.end),d=this.model.get("products"),_.each(d,function(a){if(a.get("processes")){var b=$.grep(a.get("processes"),function(a){return"retrieve_data"==a.id});b&&this.swarm_prod.push(a)}a.get("model")&&this.models.push(a)},this);var g=this.$el.find("#products");g.append("<div>Products:</div>"),g.append('<ul style="padding-left:15px">');var h=g.find("ul");if(_.each(this.swarm_prod,function(a){h.append('<li style="list-style-type: circle; padding-left:-6px;list-style-position: initial;">'+a.get("name")+"</li>")},this),this.models.length>0){var i=this.$el.find("#model");i.append("<div>Models:</div>"),i.append('<ul style="padding-left:15px">'),h=i.find("ul"),_.each(this.models,function(a){h.append('<li style="list-style-type: circle; padding-left:-6px;list-style-position: initial;">'+a.get("name")+"</li>")},this)}},renderFilterList:function(a){var b=this.$el.find("#filters");b.empty(),b.append("<div>Filters</div>"),_.each(_.keys(a),function(c){var d=a[c].map(this.round),e="",g=c.split("_");if(g.length>1){e=g[0];for(var h=1;h<g.length;h++)e+=(" "+g[h]).sub()}else e=c;var i=$(f({id:c,name:e,extent:d}));b.append(i)},this)},round:function(a){return a.toFixed(2)},onStartDownloadClicked:function(){function a(){return l.submit(),!1}var b=$("#div-downloads"),d={};d.format=this.$("#select-output-format").val(),d.begin_time=this.start_picker.datepicker("getDate"),d.begin_time=new Date(Date.UTC(d.begin_time.getFullYear(),d.begin_time.getMonth(),d.begin_time.getDate(),d.begin_time.getHours(),d.begin_time.getMinutes(),d.begin_time.getSeconds())),d.begin_time.setUTCHours(0,0,0,0),d.begin_time=getISODateTimeString(d.begin_time),d.end_time=this.end_picker.datepicker("getDate"),d.end_time=new Date(Date.UTC(d.end_time.getFullYear(),d.end_time.getMonth(),d.end_time.getDate(),d.end_time.getHours(),d.end_time.getMinutes(),d.end_time.getSeconds())),d.end_time.setUTCHours(23,59,59,999),d.end_time=getISODateTimeString(d.end_time),d.collection_ids=this.swarm_prod.map(function(a){return a.get("views")[0].id}).join(","),d.model_ids=this.models.map(function(a){return a.get("download").id}).join(",");var e=_.find(c.products.models,function(a){return null!=a.get("shc")});e&&(d.shc=e.get("shc"));var f=[],i=this.$el.find(".input-group");_.each(i,function(a){for(var b=$(a).find("textarea"),c=[],d=b.length-1;d>=0;d--)c[d]=parseFloat(b[d].value);c.sort(function(a,b){return a-b}),f.push(a.id+":"+c.join(","))}),d.filters=f.join(";");var j=this.swarm_prod.map(function(a){return a.get("views")[0].urls[0]})[0],k=g(d),l=$(h({url:j,xml:k}));b.append(l);a()},onClose:function(){b.mediator.trigger("ui:close","download"),this.close()}});return{DownloadFilterView:i}})}).call(this);