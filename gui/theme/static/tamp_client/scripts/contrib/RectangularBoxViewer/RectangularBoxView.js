define(["app","./X3DOMView","globals","communicator","underscore","jqueryui"],function(a,b,c,d,e){"use strict";var f=b.extend({initialize:function(a){this.options=a,b.prototype.initialize.call(this,a),this.enableEmptyView(!0),this.setupContext()},setupContext:function(){this.currentAoI=[17.6726953125,56.8705859375,19.3865625,58.12302734375],this.currentToI=null,this.context=new RBV.Context({mediator:d.mediator,globals:c,toi:this.toi(),aoi:[this.currentAoI,0,1e5]});var a=new VMANIP.Layers.WCS({id:"ACE2",urls:["http://data.eox.at/elevation?"],crs:["SRS","EPSG:4326"],outputCRS:"http://www.opengis.net/def/crs/EPSG/0/4326",format:"image/x-aaigrid",datatype:"text"});a.registerMimeTypeHandler("image/x-aaigrid",function(a,b){for(var c=a.split("\n"),d=parseInt(c[8].replace("ncols","")),e=parseInt(c[9].replace("nrows","")),f=[],g=0,h=0,i=0;e>i;++i)for(var j=c[i+14].split(" "),k=1;500>k;++k){var l=parseFloat(j[k]);l>g&&(g=j[k]),h>l&&(h=j[k]),"undefined"==typeof f[k-1]&&(f[k-1]=[]),f[k-1].push(j[k])}return b.height=d-1,b.width=e-1,b.maxHMvalue=g,b.minHMvalue=h,b.minXvalue=0,b.minZvalue=0,b.maxXvalue=d-1,b.maxZvalue=e-1,b.heightmap=f,!0}),this.context.addLayer("terrain",a.id,a)},setupScene:function(){this.context.setToI(this.toi()),this.context.setAoI(this.currentAoI,0,1e5),this.scene=new RBV.Scene({context:this.context,x3dscene_id:this.options.x3dscene_id}),this.modelTerrainWithOverlay=new RBV.Models.DemWithOverlays},_createScene:function(a){this.enableEmptyView(!1),this.onShow(),this.scene?(this.modelTerrainWithOverlay.reset(),this.context.setToI(this.toi()),this.context.setAoI(this.currentAoI,0,1e5)):this.setupScene(),this.scene.addModel(this.modelTerrainWithOverlay),this.scene.show()},supportsLayer:function(a){var b=e.find(a.get("views"),function(a){return"WMS"===a.protocol.toUpperCase()});return b?b:null},onLayerAdd:function(a,b,c){e.forEach(c,function(a){var b=this.context.getLayerById(a.id,"imagery");this.context.trigger("change:layer:visibility",b,!0)}.bind(this))},onLayerRemove:function(a,b,c){e.forEach(c,function(a){var b=this.context.getLayerById(a.id,"imagery");this.context.trigger("change:layer:visibility",b,!0)}.bind(this))},_onUpdateOpacity:function(a){var b=e.find(a.model.get("views"),function(a){return"WMS"===a.protocol.toUpperCase()});b&&this.context.updateLayerOpacity(b.id,a.value)},didInsertElement:function(){this.listenTo(this.legacyContext(),"selection:changed",this._setAreaOfInterest),this.listenTo(this.legacyContext(),"time:change",this._onTimeChange),this.listenTo(this.legacyContext(),"productCollection:updateOpacity",this._onUpdateOpacity)},showEmptyView:function(){this.$el.html('<div class="empty-view">Please select an Area of Interest (AoI) in one of the map viewer!</div>')},hideEmptyView:function(){this.$el.html("")},_setAreaOfInterest:function(a){if(a){var b=this.currentToI;if(!b){var c=new Date(this.legacyContext().timeOfInterest.start),d=new Date(this.legacyContext().timeOfInterest.end);b=this.currentToI=c.toISOString()+"/"+d.toISOString()}var e=a.geometry.bounds;this.currentAoI=[e.left,e.bottom,e.right,e.top],this._createScene(this.options,{aoi:this.currentAoI,toi:b})}},_onTimeChange:function(a){var b=new Date(a.start),c=new Date(a.end);this.currentToI=b.toISOString()+"/"+c.toISOString(),this.currentAoI&&this._createScene(e.extend(this.sceneDefaults,this.options,{aoi:this.currentAoI,toi:this.currentToI}))},toi:function(){var a=this.currentToI;if(!a){var b=new Date(this.legacyContext().timeOfInterest.start),c=new Date(this.legacyContext().timeOfInterest.end);a=this.currentToI=b.toISOString()+"/"+c.toISOString()}return a}});return f});