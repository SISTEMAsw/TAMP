function defaultFor(a,b){return"undefined"!=typeof a?a:b}var ELEVATION_EXAGERATION=70;define(["backbone.marionette","communicator","app","models/MapModel","globals","papaparse","hbs!tmpl/wps_get_time_data","hbs!tmpl/wcs_get_coverage","cesium/Cesium","drawhelper","FileSaver","geotiff","plotty","analytics"],function(a,b,c,d,e,f,g,h){var i=a.View.extend({model:new d.MapModel,initialize:function(a){var b=$("<canvas></canvas>")[0];this.p_plot=new plotty.plot(b,null,1,1),this.map=void 0,this.isClosed=!0,this.tileManager=a.tileManager,this.selectionType=null,this.overlay_index=99,this.diffimage_index=this.overlay_index-10,this.diff_overlay=null,this.overlay_layers=[],this.overlay_offset=100,this.camera_is_moving=!1,this.camera_last_position=null,this.billboards=null,this.activeFL=[],this.features_collection={},this.coverages_collections={},this.FL_collection={},this.bboxsel=null,this.extentPrimitive=null,this.activeModels=[],this.difference_image=null,this.begin_time=null,this.end_time=null,this.stackedDataset=[],this.playback=!1,this.pickingActive=!1,this.bboxActive=!1,this.special1dData=[],this.currentCoverages=[],this.selection_x="",this.selection_y="",Cesium.Camera.DEFAULT_VIEW_RECTANGLE=Cesium.Rectangle.fromDegrees(-5,-40,40,90),Cesium.WebMapServiceImageryProvider.prototype.updateProperties=function(a,b){a="&"+a+"=",b=""+b;var c=_.indexOf(this._tileProvider._urlParts,a);c>=0?this._tileProvider._urlParts[c+1]=b:(this._tileProvider._urlParts.push(a),this._tileProvider._urlParts.push(encodeURIComponent(b)))},this.wcscanvas=$("<canvas></canvas>"),$(window).resize(function(){this.map&&this.onResize()}.bind(this)),plotty.addColorScale("redblue",["#ff0000","#0000ff"],[0,1]),plotty.addColorScale("coolwarm",["#ff0000","#ffffff","#0000ff"],[0,.5,1]),plotty.addColorScale("custom1",["#400040","#3b004d","#36005b","#320068","#2d0076","#290084","#240091","#20009f","#1b00ad","#1600ba","#1200c8","#0d00d6","#0900e3","#0400f1","#0000ff","#0217ff","#042eff","#0645ff","#095cff","#0b73ff","#0d8bff","#10a2ff","#12b9ff","#14d0ff","#17e7ff","#19ffff","#3fffff","#66ffff","#8cffff","#b2ffff","#d8ffff","#ffffff","#ffffd4","#ffffaa","#ffff7f","#ffff54","#ffff2a","#ffff00","#ffed00","#ffdd00","#ffcc00","#ffba00","#ffaa00","#ff9900","#ff8700","#ff7700","#ff6600","#ff5400","#ff4400","#ff3300","#ff2100","#ff1100","#ff0000","#ff0017","#ff002e","#ff0045","#ff005c","#ff0073","#ff008b","#ff00a2","#ff00b9","#ff00d0","#ff00e7","#ff00ff"],[0,.01587301587,.03174603174,.04761904761,.06349206348,.07936507935,.09523809522,.11111111109,.12698412696,.14285714283,.1587301587,.17460317457,.19047619044,.20634920631,.22222222218,.23809523805,.25396825392,.26984126979,.28571428566,.30158730153,.3174603174,.33333333327,.34920634914,.36507936501,.38095238088,.39682539675,.41269841262,.42857142849,.44444444436,.46031746023,.4761904761,.49206349197,.50793650784,.52380952371,.53968253958,.55555555545,.57142857132,.58730158719,.60317460306,.61904761893,.6349206348,.65079365067,.66666666654,.68253968241,.69841269828,.71428571415,.73015873002,.74603174589,.76190476176,.77777777763,.7936507935,.80952380937,.82539682524,.84126984111,.85714285698,.87301587285,.88888888872,.90476190459,.92063492046,.93650793633,.9523809522,.96825396807,.98412698394,1]),plotty.addColorScale("custom2",["#000000","#030aff","#204aff","#3c8aff","#77c4ff","#f0ffff","#f0ffff","#f2ff7f","#ffff00","#ff831e","#ff083d","#ff00ff"],[0,1e-10,.1,.2,.3333,.4666,.5333,.6666,.8,.9,.999999999999,1]),plotty.addColorScale("blackwhite",["#000000","#ffffff"],[0,1])},createMap:function(){this.$el.attr("style","height:100%;"),Cesium.BingMapsApi.defaultKey="NOTHING",Cesium.Camera.DEFAULT_VIEW_RECTANGLE=Cesium.Rectangle.fromDegrees(0,-10,30,55),Cesium.WebMapServiceImageryProvider.prototype.updateProperties=function(a,b){a="&"+a+"=",b=""+b;var c=_.indexOf(this._tileProvider._urlParts,a);c>=0?this._tileProvider._urlParts[c+1]=b:(this._tileProvider._urlParts.push(a),this._tileProvider._urlParts.push(encodeURIComponent(b)))},this.$el.append("<div id='cesium_attribution'></div>"),this.$el.append("<div id='cesium_custom_attribution'></div>"),$("#cesium_custom_attribution").append("<div style='float:left'><a href='http://cesiumjs.org' target='_blank'>Cesium</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>"),this.$el.append('<div type="button" class="btn btn-success darkbutton" id="cesium_save">Save as Image</div>');var a,b="";this.colors=e.objects.get("color"),null==this.begin_time||null==this.end_time,e.baseLayers.each(function(c){c.get("visible")&&(b=c.get("name"),a=this.createLayer(c))},this);var c=new Cesium.Clock({startTime:Cesium.JulianDate.fromIso8601("2014-01-01"),currentTime:Cesium.JulianDate.fromIso8601("2014-01-02"),stopTime:Cesium.JulianDate.fromIso8601("2014-01-03"),clockRange:Cesium.ClockRange.LOOP_STOP,clockStep:Cesium.ClockStep.SYSTEM_CLOCK_MULTIPLIER,canAnimate:!1,shouldAnimate:!1});a&&(this.map=new Cesium.Viewer(this.el,{timeline:!1,fullscreenButton:!1,baseLayerPicker:!1,homeButton:!1,infoBox:!1,navigationHelpButton:!1,navigationInstructionsInitiallyVisible:!1,animation:!1,imageryProvider:a,terrainProvider:new Cesium.CesiumTerrainProvider({url:"//tiles.maps.eox.at/dem"}),creditContainer:"cesium_attribution",contextOptions:{webgl:{preserveDrawingBuffer:!0}},clock:c})),$(".gui").remove(),this.map.entities.add({id:"needle",position:Cesium.Cartesian3.fromDegrees(0,0,6e5),show:!1,point:{color:Cesium.Color.RED,pixelSize:12,outlineColor:Cesium.Color.WHITE,outlineWidth:2},polyline:{positions:[Cesium.Cartesian3.fromDegrees(0,0,0),Cesium.Cartesian3.fromDegrees(0,0,6e5)],followSurface:!1,width:2,material:Cesium.Color.RED}});var d=e.objects.get("mapmodel");this.navigationhelp=new Cesium.NavigationHelpButton({container:$(".cesium-viewer-toolbar")[0]});this.map.canvas;this.map.scene.skyBox.show=d.get("skyBox"),this.map.scene.sun.show=d.get("sun"),this.map.scene.moon.show=d.get("moon"),this.map.scene.skyAtmosphere.show=d.get("skyAtmosphere"),this.map.scene.backgroundColor=new Cesium.Color.fromCssColorString(d.get("backgroundColor")),this.map.scene.hasOwnProperty("fog")&&(this.map.scene.fog.enabled=!1),$(".cesium-viewer-geocoderContainer").remove(),this.map.scene._oit.isSupported=function(){return!1},this.billboards=this.map.scene.primitives.add(new Cesium.BillboardCollection),this.drawhelper=new DrawHelper(this.map.cesiumWidget),this.drawhelper._handlersMuted=!0,this.camera_last_position={},this.camera_last_position.x=this.map.scene.camera.position.x,this.camera_last_position.y=this.map.scene.camera.position.y,this.camera_last_position.z=this.map.scene.camera.position.z,this.map.scene.camera.frustum.far=15*this.map.scene.camera.frustum.far,this.map.clock.onTick.addEventListener(this.handleTick.bind(this)),e.baseLayers.each(function(a){if(a.get("name")==b){var c=this.map.scene.imageryLayers.get(0);c.show=!0,a.set("ces_layer",c)}},this),e.baseLayers.each(function(a){if(a.get("name")!=b){var c=this.createLayer(a);if(c){var d=this.map.scene.imageryLayers.addImageryProvider(c);d.show=a.get("visible"),a.set("ces_layer",d)}}},this),_.each(e.products.last(e.products.length).reverse(),function(a){var b=this.createLayer(a);if(b){var c=this.map.scene.imageryLayers.addImageryProvider(b);if(a.set("ces_layer",c),c.show=a.get("visible"),c.alpha=a.get("opacity"),"WMS"!=a.get("views")[0].protocol&&"WMTS"!=a.get("views")[0].protocol&&(c.show=!1),a.get("visible")){({name:a.get("name"),isBaseLayer:!1,visible:!0})}}},this),e.overlays.each(function(a){var b=this.createLayer(a);if(b){var c=this.map.scene.imageryLayers.addImageryProvider(b);this.map.scene.imageryLayers.remove(c,!1),c.show=a.get("visible"),this.map.scene.imageryLayers.add(c),a.set("ces_layer",c)}},this);var f=this;this.$el.on("mousedown",function(a){f.$el.on("mouseup mousemove",function b(a){function c(a,b,c){return a.split(b,c).join(b).length}function c(a,b,c){return a.split(b,c).join(b).length}if(f.pickingActive&&"mouseup"===a.type){var d=$(this).offset(),e=a.pageX-d.left,g=a.pageY-d.top,h=f.map.camera.pickEllipsoid(new Cesium.Cartesian2(e,g),f.map.scene.globe.ellipsoid),i=Cesium.Cartographic.fromCartesian(h),j=Cesium.Math.toDegrees(i.longitude),k=Cesium.Math.toDegrees(i.latitude),l={x:j,y:k};f.map.entities.getById("needle").show=!1;var m=function(a,b){if(b){var c=Cesium.Math.toDegrees(b.east),d=Cesium.Math.toDegrees(b.west),e=Cesium.Math.toDegrees(b.north),f=Cesium.Math.toDegrees(b.south);if(d<=a.x&&a.x<=c&&f<=a.y&&a.y<=e)return!0}return!1},n=[];_.each(f.map.scene.primitives._primitives,function(a){if(a.hasOwnProperty("cov_id")){var b=a.geometryInstances[0].geometry._rectangle;m(l,b)&&n.push(a)}a.hasOwnProperty("_primitives")&&a.show&&_.each(a._primitives,function(a){if(a.hasOwnProperty("cov_id")){var b=a.geometryInstances[0].geometry._rectangle;a.show&&m(l,b)&&n.push(a)}})});var o=f.map.entities.getById("needle");o.position.setValue(Cesium.Cartesian3.fromDegrees(j,k,6e5)),o.polyline._positions.setValue([Cesium.Cartesian3.fromDegrees(j,k,0),Cesium.Cartesian3.fromDegrees(j,k,6e5)]),f.map.entities.getById("needle").show=!0;var p=[];if(n)for(var q=!1,r=n.length-1;r>=0;r--){var s=0,t=n[r].cov_id,u=s;n[r].hasOwnProperty("height")&&(u=n[r].height,0!=u&&(q=!0));var v=n[r].geometryInstances[0].geometry._rectangle;if(-1!=f.stackedDataset.indexOf(t))for(var w=f.stackedDataset.length-1;w>=0;w--){var x=f.stackedDataset[w];if(f.p_plot.datasetAvailable(x)){var y=s,z=f.currentCoverages;for(var A in z)z[A].identifier==x&&z[A].hasOwnProperty("starttime")&&(y=new Date(z[A].starttime));var B=f.p_plot.datasetCollection[x],C=B.width,D=B.height,E=Cesium.Math.toDegrees(v.east),F=Cesium.Math.toDegrees(v.west),G=Cesium.Math.toDegrees(v.north),H=Cesium.Math.toDegrees(v.south),I=Math.abs(E-F)/C,J=Math.abs(G-H)/D,e=Math.floor(Math.abs(j-F)/I),g=Math.floor(Math.abs(k-G)/J),K=x.lastIndexOf("_"),L=x.substr(0,K);x.split("_").length>3&&(L=x.substr(0,c(x,"_",3))),s++,this.selection_x="timestamp",this.selection_y="measurement",-9999!=B.data[g*C+e]&&p.push({id:L,measurement:B.data[g*C+e],timestamp:y})}}else if(f.p_plot.datasetAvailable(t)){var B=f.p_plot.datasetCollection[t],C=B.width,D=B.height,E=Cesium.Math.toDegrees(v.east),F=Cesium.Math.toDegrees(v.west),G=Cesium.Math.toDegrees(v.north),H=Cesium.Math.toDegrees(v.south),I=Math.abs(E-F)/C,J=Math.abs(G-H)/D,e=Math.floor(Math.abs(j-F)/I),g=Math.floor(Math.abs(k-G)/J),K=t.lastIndexOf("_"),L=t.substr(0,K);t.split("_").length>3&&(L=t.substr(0,c(t,"_",3)));var y,z=f.currentCoverages;for(var A in z)z[A].identifier==t&&z[A].hasOwnProperty("starttime")&&(y=new Date(z[A].starttime));q?(this.selection_x="measurement",this.selection_y="height"):(this.selection_x="timestamp",this.selection_y="measurement"),-9999!=B.data[g*C+e]&&p.push({id:L,measurement:B.data[g*C+e],height:u,timestamp:y})}}if($("#pickingresults").empty(),$("#pickingresults").hide(),1==p.length){$("#pickingresults").show(),$("#pickingresults").empty(),$("#pickingresults").append('<div style="margin: 0 auto" id="prcontainer"></div>'),$("#prcontainer").append('<ul id="listdisplay"></ul>');var M=p[0];for(key in M)M.hasOwnProperty(key)&&$("#listdisplay").append("<li>"+M[key]+"</li>")}else if(p.length>1){$("#pickingresults").show();var N={scatterEl:$("#pickingresults")[0],selection_x:this.selection_x,selection_y:[this.selection_y],showDropDownSelection:!1,margin:{top:45,right:20,bottom:10,left:50}},O=new scatterPlot(N,function(){},function(a){},function(){},function(a){});O.loadData({parsedData:p}),$("#download_button").remove(),$("#pickingresults").find("#save").attr("style","position: absolute; right: 29px; top: 7px"),$("#pickingresults").find("#grid").attr("style","position: absolute; right: 155px; top: 7px")}}f.$el.off("mouseup mousemove",b)})}),this.$el.click(function(a){1==a.which})},onShow:function(){return this.map||this.createMap(),this.navigationhelp&&(this.navigationhelp.destroy(),this.navigationhelp=new Cesium.NavigationHelpButton({container:$(".cesium-viewer-toolbar")[0]})),this.plot=new plotty.plot({colorScale:"jet",domain:[3e4,6e4]}),this.isClosed=!1,$("#cesium_save").on("click",this.onSaveImage.bind(this)),this},onResize:function(){if(this.map._sceneModePicker){var a=this.map._sceneModePicker.container,b=this.map._sceneModePicker.viewModel._scene;this.map._sceneModePicker.destroy();var c=new Cesium.SceneModePicker(a,b);this.map._sceneModePicker=c}},createLayer:function(a){var b=null,c=a.get("views"),d=void 0;if("undefined"==typeof c)d=a.get("view");else if(1==c.length)d=c[0];else{var e=_.find(c,function(a){return"WMTS"==a.protocol});if(e)d=e;else{var f=_.find(c,function(a){return"WMS"==a.protocol});if(!f)return null;d=f}}switch(a.get("visible")&&d.attribution&&$("#cesium_custom_attribution").append("<div id='"+a.get("name")+"' style='float: left;'>"+d.attribution+"</div>"),d.protocol){case"WMTS":b=new Cesium.WebMapTileServiceImageryProvider({url:d.urls[0],layer:d.id,style:d.style,format:d.format,tileMatrixSetID:d.matrixSet,maximumLevel:12,tilingScheme:new Cesium.GeographicTilingScheme({numberOfLevelZeroTilesX:2,numberOfLevelZeroTilesY:1}),credit:new Cesium.Credit(d.attribution),show:a.get("visible")});break;case"WMS":params=$.extend({},Cesium.WebMapServiceImageryProvider.DefaultParameters);var g,h={};if(a.get("parameters")){var i=a.get("parameters"),j=_.keys(i);_.each(j,function(a){i[a].selected&&(h.dim_range=i[a].range[0]+","+i[a].range[1],g=i[a].colorscale)})}if(h.styles=g,a.get("timeSlider")){var k=getISODateTimeString(this.begin_time)+"/"+getISODateTimeString(this.end_time);h.time=k}a.get("height")&&(h.elevation=a.get("height")),params.format=a.get("views")[0].format,b=new Cesium.WebMapServiceImageryProvider({url:d.urls[0],layers:d.id,parameters:params});for(par in h)b.updateProperties(par,h[par]);break;case"WPS":b=new Cesium.SingleTileImageryProvider({url:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"});break;default:return!1}return b},centerMap:function(a){this.model.set({center:[a.x,a.y],zoom:a.l})},onSortProducts:function(a){var b=null,c=0;e.products.each(function(a){var d=a.get("ces_layer");if(d){var f=e.products.length-1-e.products.indexOf(a)+e.baseLayers.length,g=this.map.scene.imageryLayers.indexOf(d),h=f-g;Math.abs(c)<Math.abs(h)&&(c=h,b=d)}},this);for(var d=0;d<Math.abs(c);++d)0>c?this.map.scene.imageryLayers.lower(b):c>0&&this.map.scene.imageryLayers.raise(b);console.log("Map products sorted")},onUpdateOpacity:function(a){e.products.each(function(b){if(b.get("name")==a.model.get("name")){if("WCS"==b.get("views")[0].protocol){var c=this.coverages_collections[b.get("views")[0].id];if(c)for(var d=0;d<c._primitives.length;d++){var e=c._primitives[d];e.appearance.material.uniforms.alpha=a.value}}var f=b.get("ces_layer");if(_.has(this.features_collection,a.model.get("views")[0].id))for(var g=this.features_collection[a.model.get("views")[0].id],h=g.length-1;h>=0;h--){var i=g.get(h);if(i.color){var j=i.color.clone();j.alpha=a.value,i.color=j}else if(i.appearance){var j=i.appearance.material.uniforms.color.clone();j.alpha=a.value,i.appearance.material.uniforms.color=j}}else f&&(f.alpha=a.value)}},this)},changeLayer:function(a){a.isBaseLayer?(e.baseLayers.each(function(b){var c=b.get("ces_layer");c&&b.get("name")==a.name&&(c.show=!0,b.get("views")[0].attribution&&$("#cesium_custom_attribution").append("<div id='"+b.get("name")+"' style='float: left;'>"+b.get("views")[0].attribution+"</div>"))},this),e.baseLayers.each(function(b){var c=b.get("ces_layer");c&&b.get("name")!=a.name&&(c.show=!1,$("#"+b.get("name")).remove())},this)):(e.overlays.each(function(b){if(b.get("name")==a.name){var c=b.get("ces_layer");c.show=a.visible,a.visible?b.get("view").attribution&&$("#cesium_custom_attribution").append("<div id='"+b.get("name")+"' style='float: left;'>"+b.get("view").attribution+"</div>"):$("#"+b.get("name")).remove()}},this),e.products.each(function(b){if(b.get("name")==a.name){if("CZML"==b.get("views")[0].protocol);else if("WCS"==b.get("views")[0].protocol)this.checkCoverages(b,a.visible);else if("WPS"==b.get("views")[0].protocol)this.checkShc(b,a.visible);else if("WMS"==b.get("views")[0].protocol||"WMTS"==b.get("views")[0].protocol){var c=b.get("parameters"),d=b.get("coefficients_range");if(c){var f,g=_.keys(c);_.each(g,function(a){c[a].selected&&(f=a)});var h=c[f].colorscale,i=c[f].range;if("Fieldlines"==f)a.visible?this.activeFL.push(b.get("name")):-1!=this.activeFL.indexOf(b.get("name"))&&this.activeFL.splice(this.activeFL.indexOf(b.get("name")),1),this.checkFieldLines();else{var j=b.get("ces_layer");f&&j.imageryProvider.updateProperties("dim_bands",f),i&&j.imageryProvider.updateProperties("dim_range",i[0]+","+i[1]),h&&j.imageryProvider.updateProperties("styles",h),d&&j.imageryProvider.updateProperties("dim_coeff",d[0]+","+d[1]),j.show=a.visible}}else{var j=b.get("ces_layer");j.show=a.visible}}a.visible?b.get("views")[0].attribution&&$("#cesium_custom_attribution").append("<div id='"+b.get("name")+"' style='float: left;'>"+b.get("views")[0].attribution+"</div>"):$("#"+b.get("name")).remove()}b.get("model")&&b.get("name")==a.name&&(a.visible?(this.activeModels.push(b.get("name")),e.products.each(function(a){},this)):(-1!=this.activeModels.indexOf(b.get("name"))&&this.activeModels.splice(this.activeModels.indexOf(b.get("name")),1),2!=this.activeModels.length&&(this.difference_image&&this.map.scene.imageryLayers.remove(this.difference_image),this.difference_image=null,$("#colorlegend").is(":visible")&&$("#colorlegend").hide())),2==this.activeModels.length)},this))},checkShc:function(a,b){if(b){if(null!=a.get("shc")){var c,d=a.get("parameters"),e=_.keys(d);_.each(e,function(a){d[a].selected&&(c=a)});var f,g=d[c].colorscale,h=d[c].range,i=a.get("ces_layer"),j=this.map.scene.imageryLayers.indexOf(i),k=a.get("views")[0].urls[0],l=a.get("coefficients_range");$.post(k,Tmpl_eval_model({model:"Custom_Model",variable:c,begin_time:getISODateTimeString(this.begin_time),end_time:getISODateTimeString(this.end_time),elevation:a.get("height"),coeff_min:l[0],coeff_max:l[1],shc:a.get("shc"),height:512,width:1024,style:g,range_min:h[0],range_max:h[1]})).done(function(b){that.map.scene.imageryLayers.remove(i),f="data:image/gif;base64,"+b;var c=new Cesium.SingleTileImageryProvider({url:f});i=that.map.scene.imageryLayers.addImageryProvider(c,j),a.set("ces_layer",i);for(var d=that.map.scene.imageryLayers.indexOf(i),e=j-d,g=0;g<Math.abs(e);++g)0>e?that.map.scene.imageryLayers.lower(i):e>0&&that.map.scene.imageryLayers.raise(i)})}}else{var i=a.get("ces_layer");i.show=b}},createCurtain:function(a,b,c,d,e,f){for(var g=new Cesium.Material({fabric:{uniforms:{image:a,repeat:new Cesium.Cartesian2(-1,-1),alpha:e},components:{diffuse:"texture2D(image, fract(repeat * materialInput.st)).rgb",alpha:"texture2D(image, fract(repeat * materialInput.st)).a * alpha"}},flat:!0,translucent:!0}),h=[],i=[],j=b.length/2-1;j>=0;j--)h.push(f),i.push(0);var k=new Cesium.WallGeometry({positions:Cesium.Cartesian3.fromDegreesArray(b),minimumHeights:h,maximumHeights:i}),l=Cesium.WallGeometry.createGeometry(k),m=new Cesium.GeometryInstance({geometry:l}),n=new Cesium.Primitive({geometryInstances:[m],appearance:new Cesium.MaterialAppearance({translucent:!0,flat:!0,material:g}),releaseGeometryInstances:!1});n.cov_id=c,d.add(n)},createPrimitive:function(a,b,c,d,e,f){f=defaultFor(f,0),e=defaultFor(e,1);var g=new Cesium.GeometryInstance({geometry:new Cesium.RectangleGeometry({rectangle:Cesium.Rectangle.fromDegrees(b[0],b[1],b[2],b[3]),vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT,height:f})}),h=new Cesium.Material({fabric:{uniforms:{image:a,repeat:new Cesium.Cartesian2(1,1),alpha:e},components:{diffuse:"texture2D(image, fract(repeat * materialInput.st)).rgb",alpha:"texture2D(image, fract(repeat * materialInput.st)).a * alpha"}},flat:!0,translucent:!0}),i=new Cesium.Primitive({geometryInstances:[g],appearance:new Cesium.MaterialAppearance({translucent:!0,flat:!0,material:h}),releaseGeometryInstances:!1});i.cov_id=c,i.height=f/ELEVATION_EXAGERATION,d.add(i)},loadCoverage:function(a,b,c,d,e,f,g,h){var i=this;return $.ajax({dataType:"arraybuffer",type:"GET",url:a}).done(function(a){var j=GeoTIFF.parse(a),k=j.getImage(0),l=k.readRasters(),m=k.getGDALMetadata();if(m&&m.hasOwnProperty("COORDINATES")&&m.hasOwnProperty("HEIGHT_LEVELS")&&m.hasOwnProperty("HEIGHT_LEVELS_NUMBER")){for(var n=m.COORDINATES.split(","),o=[],p=n.length-1;p>=0;p--)o=o.concat($.trim(n[p]).split(" ").map(Number));var q=m.HEIGHT_LEVELS.split(" ");q=Number(q[q.length-1])*ELEVATION_EXAGERATION/10,i.p_plot.addDataset(c,l[0],k.getWidth(),k.getHeight()),i.p_plot.setDomain(d),i.p_plot.setNoDataValue(-9999),i.p_plot.setClamp(g[0],g[1]),i.p_plot.renderDataset(c),h?(h.cov_id=c,h.appearance.material._textures.image.copyFrom(i.p_plot.canvas)):i.createCurtain(i.p_plot.canvas.toDataURL(),o,c,e,f,q)}else if(l.length>1){var r;m&&m.hasOwnProperty("VERTICAL_LEVELS")&&(r=m.VERTICAL_LEVELS.split(",").map(Number)),r[r.length-1]>99999&&(r.pop(),l.pop());for(var p=0;p<l.length;p++){i.p_plot.addDataset(c+"_"+p,l[p],k.getWidth(),k.getHeight()),i.p_plot.setDomain(d),i.p_plot.setNoDataValue(-9999),i.p_plot.setClamp(g[0],g[1]),i.p_plot.renderDataset(c+"_"+p);var q=18e3*p;p<=r.length&&(q=r[p]*ELEVATION_EXAGERATION),i.createPrimitive(i.p_plot.canvas.toDataURL(),b,c+"_"+p,e,f,q)}}else i.p_plot.addDataset(c,l[0],k.getWidth(),k.getHeight()),i.p_plot.setDomain(d),i.p_plot.setNoDataValue(-9999),i.p_plot.setClamp(g[0],g[1]),i.p_plot.renderDataset(c),h?(h.cov_id=c,h.appearance.material._textures.image.copyFrom(i.p_plot.canvas)):i.createPrimitive(i.p_plot.canvas.toDataURL(),b,c,e,f)})},addCoverage:function(a,b){var c=this;return $.ajax({dataType:"arraybuffer",type:"GET",url:a}).done(function(a){var d=GeoTIFF.parse(a),e=d.getImage(0),f=e.readRasters()[0];c.p_plot.addDataset(b,f,e.getWidth(),e.getHeight()),c.stackedDataset.push(b)})},checkCoverages:function(a,c){b.mediator.trigger("date:tick:select",!1),$("#playercontrols").hide(),$("#timestamp").hide(),_.has(this.coverages_collections,a.get("views")[0].id)||(this.coverages_collections[a.get("views")[0].id]=new Cesium.PrimitiveCollection,this.map.scene.primitives.add(this.coverages_collections[a.get("views")[0].id]));var d=this.coverages_collections[a.get("views")[0].id];if(c){d.show=!0;var e=a.get("color");e=e.substring(1,e.length);var h,i=a.get("parameters"),j=_.keys(i);_.each(j,function(a){i[a].selected&&(h=a)});var k=i[h].colorscale,l=defaultFor(i[h].clamp_min,!1),m=defaultFor(i[h].clamp_max,!1),n=(a.get("outlines"),i[h].range),o=a.get("opacity"),p=a.get("views")[0].urls[0],q=a.get("views")[0].id,r=this;this.p_plot.setColorScale(k),$.post(p,g({collection:q,begin_time:getISODateTimeString(this.begin_time),end_time:getISODateTimeString(this.end_time)}),"xml").done(function(a){function c(a){if(1==a.length||0==a.length)return!1;for(var b=0;b<a.length-1;b++)if(a[b].bbox!=a[b+1].bbox)return!1;return!0}var e=f.parse(a,{header:!0,skipEmptyLines:!0});r.currentCoverages=r.currentCoverages.concat(e.data);var g=c(e.data),h=null;if(g){for(var i=r.stackedDataset.length-1;i>=0;i--)_.find(e.data,function(a){return a.identifier==r.stackedDataset[i]})||r.p_plot.datasetAvailable(r.stackedDataset[i])&&(r.p_plot.removeDataset(r.stackedDataset[i]),r.stackedDataset.splice(i,1));for(var j=0;j<d._primitives.length;j++)_.find(r.stackedDataset,function(a){return a==r.stackedDataset[i]})||(h=d._primitives[j])}else{for(var k=[],j=0;j<d._primitives.length;j++)_.find(e.data,function(a){return a.identifier==d._primitives[j].cov_id})||k.push(d._primitives[j]);for(var i=k.length-1;i>=0;i--)r.p_plot.removeDataset(k[i].cov_id),d.remove(k[i])}var q=[];e.data=_.sortBy(e.data,function(a){return Date.parse(a.starttime)});for(var i=e.data.length-1;i>=0;i--){var s=e.data[i].bbox;s=s.substring(1,s.length-1).split(",").map(parseFloat);var t=p.substring(0,p.length-11)+"/davprc/coverage/"+e.data[i].identifier;if("PARAMARIBO"!=e.data[i].identifier&&"Wiener Neustadt"!=e.data[i].identifier&&"Sonnblick"!=e.data[i].identifier){if(!_.find(d._primitives,function(a){return a.cov_id==e.data[i].identifier})){var s=s,u=e.data[i].identifier;r.p_plot;g?g&&i==e.data.length-1?(q.push(r.loadCoverage(t,s,u,n,d,o,[l,m],h)),r.stackedDataset.push(u),b.mediator.trigger("date:tick:select",new Date(e.data[i].starttime))):r.p_plot.datasetAvailable(u)||q.push(r.addCoverage(t,u)):q.push(r.loadCoverage(t,s,u,n,d,o,[l,m],null))}}else $.ajax({dataType:"arraybuffer",type:"GET",dataType:"xml",url:t}).done(function(a){for(var b=a.getElementsByTagName("data"),c=a.getElementsByTagName("siteName")[0].textContent,d=a.getElementsByTagName("field")[0].textContent.replace(/ /g,"_"),e=b.length-1;e>=0;e--){var f={};f.id=c,f[d]=Number(b[e].getElementsByTagName("value")[0].textContent),f.timestamp=new Date(b[e].getElementsByTagName("timeStart")[0].textContent),r.special1dData.push(f)}$("#pickingresults").show();var g={scatterEl:$("#pickingresults")[0],selection_x:"timestamp",selection_y:[d],showDropDownSelection:!1,margin:{top:45,right:20,bottom:10,left:50}},h=new scatterPlot(g,function(){},function(a){},function(){},function(a){});h.loadData({parsedData:r.special1dData}),$("#download_button").remove(),$("#pickingresults").find("#save").attr("style","position: absolute; right: 29px; top: 7px"),$("#pickingresults").find("#grid").attr("style","position: absolute; right: 155px; top: 7px"),$("#pickingresults").prepend('<button type="button" id="pickingresultsClose" class="close" style="position: absolute; right:0px; margin-right:5px; margin-top:5px;"><i class="fa fa-times-circle"></i></button>'),$("#pickingresultsClose").click(function(){r.special1dData=[],$("#pickingresults").hide(),$("#pickingresults").empty()})})}$.when.apply($,q).then(function(){if(g){var a=e.data,c=d._primitives[0],f=a.length,h=f-1,i=15;$("#playercontrols").show(),$("#play-button").off(),$("#play-button").on("click",function(){function d(){setTimeout(function(){r.playback&&(Cesium.requestAnimationFrame(d),h=(h+1)%f,r.p_plot.renderDataset(a[h].identifier),c.appearance.material._textures.image.copyFrom(r.p_plot.canvas),c.cov_id=a[h].identifier,b.mediator.trigger("date:tick:select",new Date(a[h].starttime)),$("#timestamp").show(),$("#timestamp").text(a[h].starttime))},100/i)}$("#play-button").html('<i class="fa fa-pause"></i>'),r.playback?(r.playback=!1,$("#play-button").html('<i class="fa fa-play"></i>')):(r.playback=!0,d())}),$("#step-back-button").off(),$("#step-back-button").on("click",function(){h-=1,0>h&&(h=f-1),h%=f,r.p_plot.renderDataset(a[h].identifier),c.appearance.material._textures.image.copyFrom(r.p_plot.canvas),c.cov_id=a[h].identifier,b.mediator.trigger("date:tick:select",new Date(a[h].starttime))}),$("#step-forward-button").off(),$("#step-forward-button").on("click",function(){h=(h+1)%f,r.p_plot.renderDataset(a[h].identifier),c.appearance.material._textures.image.copyFrom(r.p_plot.canvas),c.cov_id=a[h].identifier,b.mediator.trigger("date:tick:select",new Date(a[h].starttime))})}}).fail(function(){}).always(function(){})})}else d.show=!1},checkLayerFeatures:function(a,b){var c=a.get("views")[0].id;if(this.features_collection.hasOwnProperty(c)&&(this.map.scene.primitives.remove(this.features_collection[c]),delete this.features_collection[c]),b){var d=a.get("color");d=d.substring(1,d.length);var e,g=a.get("parameters"),h=_.keys(g);_.each(h,function(a){g[a].selected&&(e=a)});var i=g[e].colorscale,j=(a.get("outlines"),g[e].range),k=a.get("opacity"),l=a.get("views")[0].urls[0],m=this;$.post(l,Tmpl_retrive_swarm_features({model_ids:this.activeModels.join(),collection_id:c,begin_time:getISODateTimeString(this.begin_time),end_time:getISODateTimeString(this.end_time),band:e,alpha:k,style:i,dim_range:j[0]+","+j[1]})).done(function(a){f.parse(a,{header:!0,dynamicTyping:!0,complete:function(a){m.createFeatures(a,c,e,k)}})})}},createFeatures:function(a,b,c,d){this.features_collection.hasOwnProperty(b)&&(this.map.scene.primitives.remove(this.features_collection[b]),delete this.features_collection[b]),"B_NEC"==c?(this.features_collection[b]=new Cesium.PrimitiveCollection,_.each(a.data,function(a){var c=new Cesium.Material.fromType("PolylineArrow");c.uniforms.color=Cesium.Color.fromBytes(a.col_r,a.col_g,a.col_b,255*d),this.features_collection[b].add(new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:new Cesium.PolylineGeometry({positions:[new Cesium.Cartesian3(a.pos1_x,a.pos1_y,a.rad1),new Cesium.Cartesian3(a.pos2_x,a.pos2_y,a.rad2)],width:5,vertexFormat:Cesium.PolylineMaterialAppearance.VERTEX_FORMAT})}),appearance:new Cesium.PolylineMaterialAppearance({material:c})}))},this),this.map.scene.primitives.add(this.features_collection[b])):(this.features_collection[b]=new Cesium.PointPrimitiveCollection,_.each(a.data,function(a){var c=Cesium.Color.fromBytes(a.col_r,a.col_g,a.col_b,255*d);this.features_collection[b].add({position:new Cesium.Cartesian3(a.pos_x,a.pos_y,a.rad),color:c,pixelSize:8})},this),this.map.scene.primitives.add(this.features_collection[b]))},onLayerRangeChanged:function(a,b,c){var d=this;e.products.each(function(c){if(c.get("name")==a&&"WCS"==c.get("views")[0].protocol){var e=d.coverages_collections[c.get("views")[0].id];if(e)for(var f=0;f<e._primitives.length;f++){var g=e._primitives[f],h=d.p_plot;h.setDomain(b),h.renderDataset(g.cov_id),g.appearance.material._textures.image.copyFrom(h.canvas)}}})},OnLayerParametersChanged:function(a){var b=this;e.products.each(function(c){if(c.get("name")==a){var d=c.get("color");d=d.substring(1,d.length);var e,f=c.get("parameters"),g=_.keys(f);_.each(g,function(a){f[a].selected&&(e=a)});var h=f[e].colorscale,i=f[e].range,j=defaultFor(f[e].clamp_min,!1),k=defaultFor(f[e].clamp_max,!1),l=(c.get("outlines"),c.get("height")),m=c.get("coefficients_range");if("CZML"==c.get("views")[0].protocol)this.checkLayerFeatures(c,c.get("visible"));else if("WCS"==c.get("views")[0].protocol){var n=this.coverages_collections[c.get("views")[0].id];if(n)for(var o=0;o<n._primitives.length;o++){var p=n._primitives[o],q=b.p_plot;q.setDomain(i),q.setColorScale(h),q.setClamp(j,k),q.renderDataset(p.cov_id),p.appearance.material._textures.image.copyFrom(q.canvas)}}else if("WMS"==c.get("views")[0].protocol){if("Fieldlines"==e){if(c.get("visible")){var r=c.get("ces_layer");this.map.scene.imageryLayers.remove(r,!1),-1==this.activeFL.indexOf(c.get("name"))&&this.activeFL.push(c.get("name"))}else-1!=this.activeFL.indexOf(c.get("name"))&&this.activeFL.splice(this.activeFL.indexOf(c.get("name")),1);this.checkFieldLines()}else if(-1!=this.activeFL.indexOf(c.get("name"))&&this.activeFL.splice(this.activeFL.indexOf(c.get("name")),1),this.checkFieldLines(),c.get("name")==a){var r=c.get("ces_layer");if(c.get("visible")&&(r.show=!0),r.imageryProvider.updateProperties("dim_bands",e),r.imageryProvider.updateProperties("dim_range",i[0]+","+i[1]),r.imageryProvider.updateProperties("elevation",l),h&&r.imageryProvider.updateProperties("styles",h),m&&r.imageryProvider.updateProperties("dim_coeff",m[0]+","+m[1]),r.show){var s=this.map.scene.imageryLayers.indexOf(r);this.map.scene.imageryLayers.remove(r,!1),this.map.scene.imageryLayers.add(r,s)}}}else"WPS"==c.get("views")[0].protocol&&this.checkShc(c,c.get("visible"))}},this)},onExportGeoJSON:function(){var a=this.geojson.write(this.vectorLayer.features,!0),b=new Blob([a],{type:"text/plain;charset=utf-8"});saveAs(b,"selection.geojson")},onGetGeoJSON:function(){return this.geojson.write(this.vectorLayer.features,!0)},onGetMapExtent:function(){return this.getMapExtent()},getMapExtent:function(){var a=this.map.scene.globe.ellipsoid,b=new Cesium.Cartesian2(0,0),c=this.map.scene.camera.pickEllipsoid(b,a);b=new Cesium.Cartesian2(this.map.scene.canvas.width,this.map.scene.canvas.height);var d=this.map.scene.camera.pickEllipsoid(b,a);if(null!=c&&null!=d)return c=a.cartesianToCartographic(c),d=a.cartesianToCartographic(d),{left:Cesium.Math.toDegrees(c.longitude),bottom:Cesium.Math.toDegrees(d.latitude),right:Cesium.Math.toDegrees(d.longitude),top:Cesium.Math.toDegrees(c.latitude)};var e=new Cesium.Cartesian2(this.map.scene.canvas.width/2,this.map.scene.canvas.height/2);
return e=this.map.scene.camera.pickEllipsoid(e,a),null!=e?(e=a.cartesianToCartographic(e),{left:Cesium.Math.toDegrees(e.longitude)-90,bottom:Cesium.Math.toDegrees(e.latitude)-45,right:Cesium.Math.toDegrees(e.longitude)+90,top:Cesium.Math.toDegrees(e.latitude)+45}):{left:-180,bottom:-90,right:180,top:90}},onSelectionActivated:function(a){if(this.selectionType=a.selectionType,"pointSelection"==a.id)a.active?(this.bboxSelection&&(this.bboxSelection=!1,b.mediator.trigger("selection:changed",null),this.drawhelper.stopDrawing()),this.pickingActive=!0):(this.pickingActive=!1,this.map.entities.getById("needle").show=!1,$("#pickingresults").empty(),$("#pickingresults").hide());else if("bboxSelection"==a.id)if(a.active){this.drawhelper.startDrawingRectangle({callback:function(a){var c={n:Cesium.Math.toDegrees(a.north),e:Cesium.Math.toDegrees(a.east),s:Cesium.Math.toDegrees(a.south),w:Cesium.Math.toDegrees(a.west)};b.mediator.trigger("selection:changed",c),$("#bb_selection").html("Clear Selection")}})}else this.drawhelper.stopDrawing(),this.drawhelper._handlersMuted=!0},onSelectionChanged:function(a){if(this.drawhelper._handlersMuted=!0,a){var b="#6699FF",c=new Cesium.Material.fromType("Color");c.uniforms.color=new Cesium.Color.fromCssColorString(b),c.uniforms.color.alpha=.2;var d=new Cesium.Rectangle(Cesium.Math.toRadians(a.w),Cesium.Math.toRadians(a.s),Cesium.Math.toRadians(a.e),Cesium.Math.toRadians(a.n));this.bboxsel=[a.s,a.w,a.n,a.e],this.extentPrimitive=new DrawHelper.RectanglePrimitive({rectangle:d,material:c}),this.map.scene.primitives.add(this.extentPrimitive)}else this.bboxsel=null,this.extentPrimitive&&this.map.scene.primitives.remove(this.extentPrimitive)},checkFieldLines:function(){if(console.log(this.activeFL),this.activeFL.length>0&&this.bboxsel){var a,b,c,d,g,h,i;e.products.each(function(e){if(-1!=this.activeFL.indexOf(e.get("name"))){var j=e.get("name");a=e.get("views")[0].urls[0],b=e.get("views")[0].id,c=e.get("color"),c=c.substring(1,c.length),parameters=e.get("parameters"),_.each(_.keys(parameters),function(a){parameters[a].selected&&(d=a)}),g=parameters[d].colorscale,h=parameters[d].range,i=parameters[d].logarithmic,this.FL_collection.hasOwnProperty(j)&&(this.map.scene.primitives.remove(this.FL_collection[j]),delete this.FL_collection[j]);var k=this;$.post(a,Tmpl_get_field_lines({model_ids:b,begin_time:getISODateTimeString(this.begin_time),end_time:getISODateTimeString(this.end_time),bbox:this.bboxsel[0]+","+this.bboxsel[1]+","+this.bboxsel[2]+","+this.bboxsel[3],style:g,range_min:h[0],range_max:h[1],log_scale:i})).done(function(a){f.parse(a,{header:!0,dynamicTyping:!0,complete:function(a){k.createPrimitives(a,j)}})})}},this)}else _.each(_.keys(this.FL_collection),function(a){this.map.scene.primitives.remove(this.FL_collection[a]),delete this.FL_collection[a]},this)},onFieldlinesChanged:function(){this.checkFieldLines()},createPrimitives:function(a,b){var c={};this.FL_collection.hasOwnProperty(b)&&this.map.scene.primitives.remove(this.FL_collection[b]);var d=[];_.each(a.data,function(a){c.hasOwnProperty(a.id)?(c[a.id].colors.push(Cesium.Color.fromBytes(a.color_r,a.color_g,a.color_b,255)),c[a.id].positions.push(new Cesium.Cartesian3(a.pos_x,a.pos_y,a.pos_z))):c[a.id]={colors:[Cesium.Color.fromBytes(a.color_r,a.color_g,a.color_b,255)],positions:[new Cesium.Cartesian3(a.pos_x,a.pos_y,a.pos_z)]}}),_.each(_.keys(c),function(a){d.push(new Cesium.GeometryInstance({geometry:new Cesium.PolylineGeometry({positions:c[a].positions,width:2,vertexFormat:Cesium.PolylineColorAppearance.VERTEX_FORMAT,colors:c[a].colors,colorsPerVertex:!0})}))},this),this.FL_collection[b]=new Cesium.Primitive({geometryInstances:d,appearance:new Cesium.PolylineColorAppearance,debugShowBoundingVolume:!0}),this.map.scene.primitives.add(this.FL_collection[b])},onHighlightPoint:function(a){this.billboards.removeAll();var b=document.createElement("canvas");b.width=32,b.height=32;var c=b.getContext("2d");c.beginPath(),c.arc(16,16,12,0,Cesium.Math.TWO_PI,!0),c.closePath(),c.strokeStyle="rgb(255, 255, 255)",c.lineWidth=3,c.stroke(),c.beginPath(),c.arc(16,16,9,0,Cesium.Math.TWO_PI,!0),c.closePath(),c.strokeStyle="rgb(0, 0, 0)",c.lineWidth=3,c.stroke(),this.billboards.add({imageId:"custom canvas point",image:b,position:Cesium.Cartesian3.fromDegrees(a[1],a[0],parseInt(a[2]-6384100)),radius:a[2],scale:1})},onRemoveHighlights:function(){this.billboards.removeAll()},onTimeChange:function(a){var b=getISODateTimeString(a.start)+"/"+getISODateTimeString(a.end);this.begin_time=a.start,this.end_time=a.end,e.products.each(function(a){if(a.get("timeSlider")){a.set("time",b);var c=a.get("ces_layer");if(c&&(c.imageryProvider.updateProperties("time",b),c.show)){var d=this.map.scene.imageryLayers.indexOf(c);this.map.scene.imageryLayers.remove(c,!1),this.map.scene.imageryLayers.add(c,d)}if("CZML"==a.get("views")[0].protocol);else if("WCS"==a.get("views")[0].protocol)this.checkCoverages(a,a.get("visible"));else if("WPS"==a.get("views")[0].protocol&&a.get("visible")&&null!=a.get("shc")){var e,f=a.get("parameters"),g=_.keys(f);_.each(g,function(a){f[a].selected&&(e=a)});var h,i=f[e].colorscale,j=f[e].range,k=this,c=a.get("ces_layer"),d=this.map.scene.imageryLayers.indexOf(c),l=a.get("views")[0].urls[0];$.post(l,Tmpl_eval_model({model:"Custom_Model",variable:e,begin_time:getISODateTimeString(this.begin_time),end_time:getISODateTimeString(this.end_time),elevation:a.get("height"),shc:a.get("shc"),height:512,width:1024,style:i,range_min:j[0],range_max:j[1]})).done(function(b){k.map.scene.imageryLayers.remove(c),h="data:image/gif;base64,"+b;var e=new Cesium.SingleTileImageryProvider({url:h});c=k.map.scene.imageryLayers.addImageryProvider(e,d),a.set("ces_layer",c)})}}},this),this.checkFieldLines()},onSetExtent:function(a){},onChangeZoom:function(a){0>a?this.map.scene.camera.zoomOut(Math.abs(a)):this.map.scene.camera.zoomIn(Math.abs(a))},onClose:function(){this.isClosed=!0},isModelCompatible:function(a){var b=a.get("view").protocol;return"WMS"===b||"WMTS"===b?!0:!1},isEventListenedTo:function(a){return!!this._events[a]},onLoadImage:function(a,b){},onSaveImage:function(){this.map.canvas.toBlob(function(a){saveAs(a,"TAMP_Screenshot.jpg")},"image/jpeg")},onClearImage:function(){this.diff_overlay&&(this.map.removeLayer(this.diff_overlay),this.diff_overlay=null)},handleTick:function(a){var c=this.map.scene.camera;this.camera_is_moving?Math.abs(this.camera_last_position.x-c.position.x)<1e4&&Math.abs(this.camera_last_position.y-c.position.y)<1e4&&Math.abs(this.camera_last_position.z-c.position.z)<1e4?(this.camera_is_moving=!1,b.mediator.trigger("map:position:change",this.getMapExtent())):(this.camera_last_position.x=c.position.x,this.camera_last_position.y=c.position.y,this.camera_last_position.z=c.position.z):Math.abs(this.camera_last_position.x-c.position.x)>1e4&&Math.abs(this.camera_last_position.y-c.position.y)>1e4&&Math.abs(this.camera_last_position.z-c.position.z)>1e4&&(this.camera_is_moving=!0)},toggleDebug:function(){this.map.scene.debugShowFramesPerSecond=!this.map.scene.debugShowFramesPerSecond}});return i});