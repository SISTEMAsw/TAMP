define(["./Point","./AOIItem","globals","communicator"],function(a,b,c,d){return AOIRenderer=function(e,f,g){this._globe=e,this._navigation=f,this._aoiItems=[],this._mouseButtonDown=!1,this._mode="polygonal",this._curAoiItem=null,this._onSelectionCallback=null,this._shiftKey=!1,this._inRectangular=!1,this._aoiLayer=g,this._aoiLayer.mytoken=42,this._selectionType=null,this.colors=c.objects.get("color"),this.enableSelection=function(a,b){this._selectionType=b,"single"==b&&(this._aoiLayer.removeAllFeatures(),this._aoiItems=[]),this.start()},this.disableSelection=function(){this._aoiLayer.removeAllFeatures(),this._aoiItems=[],this.stop()},this.removeFeatures=function(){this._aoiLayer.removeAllFeatures(),this._aoiItems=[]},this.addAOI=function(a,c){var d=new b(this._aoiLayer);d.setUnclosedCoordinates(a),"undefined"!=typeof c&&d.setColor(c),d.render(),this._aoiItems.push(d)},this.start=function(){this._navigation.stop();var a=this._globe.renderContext.canvas;a.addEventListener("mousedown",h),a.addEventListener("mousemove",j),a.addEventListener("mouseup",k),a.addEventListener("contextmenu",this._handleOnContextMenu.bind(this)),console.debug("[AOIRenderer::start] called")},this.stop=function(){this._onSelectionEnd();var a=this._globe.renderContext.canvas;a.removeEventListener("mousedown",h),a.removeEventListener("mousemove",j),a.removeEventListener("mouseup",k),a.removeEventListener("contextmenu",this._handleOnContextMenu),console.debug("[AOIRenderer::stop] called"),this._navigation.start()},this.setOnSelectionStartCallback=function(a){this._onSelectionStartCallback=a},this.setOnSelectionEndCallback=function(a){this._onSelectionEndCallback=a},this.setOnSelectionMoveCallback=function(a){this._inSelectionMoveCallback=a},this.updateCurrent=function(){this._curAoiItem.render()},this._onSelectionStart=function(){this._onSelectionStartCallback&&this._onSelectionStartCallback(this._curAoiItem._coords)},this._onSelectionEnd=function(){this._onSelectionEndCallback&&this._curAoiItem&&this._onSelectionEndCallback(this._curAoiItem._coords),this._curAoiItem=null},this._onSelectionMove=function(){this._onSelectionMoveCallback&&this._onSelectionMoveCallback(this._curAoiItem._coords)},this._storePoint=function(b){var c=this._globe.renderContext.getXYRelativeToCanvas(b),d=this._globe.getLonLatFromPixel(c[0],c[1]);this._curAoiItem.add(new a(d))},this._getLatLngPoint=function(b){var c=this._globe.renderContext.getXYRelativeToCanvas(b),d=this._globe.getLonLatFromPixel(c[0],c[1]);return new a(d)};var h=function(a){this._mouseButtonDown=!0;var c=this._aoiItems.length+1;if(1===a.which){if(!this._curAoiItem){"single"==this._selectionType&&(this._aoiLayer.removeAllFeatures(),this._aoiItems=[],d.mediator.trigger("selection:changed",null),c=this._aoiItems.length);var e=this._globe.renderContext.getXYRelativeToCanvas(a),f=(this._globe.getLonLatFromPixel(e[0],e[1]),new b(this._aoiLayer)),g=this.colors(c),h=i(g);this._aoiItems.push(f),f.setColor([h.r/255,h.g/255,h.b/255,1]),this._curAoiItem=f}this._curAoiItem.add(this._getLatLngPoint(a)),this._curAoiItem.getNumPoints()>1&&(this._inRectangular=!0)}}.bind(this),i=function(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null},j=function(b){if(1===b.which&&this._mouseButtonDown&&!this._inRectangular){this._navigation.stop(),this._mode="rectangular";var c=this._curAoiItem.getStartPoint().clone(),d=this._getLatLngPoint(b);this._curAoiItem.clear(),this._curAoiItem.add(c),this._curAoiItem.add(new a([d.x,c.y])),this._curAoiItem.add(d),this._curAoiItem.add(new a([c.x,d.y])),this.updateCurrent()}}.bind(this),k=function(b){if(1===b.which){if(this._mouseButtonDown=!1,"rectangular"===this._mode){var c=this._curAoiItem.getStartPoint().clone(),d=this._getLatLngPoint(b);this._curAoiItem.clear(),this._curAoiItem.add(c),this._curAoiItem.add(new a([d.x,c.y])),this._curAoiItem.add(d),this._curAoiItem.add(new a([c.x,d.y])),this.updateCurrent(),this._onSelectionEnd(),this._navigation.start(),this._mode="polygonal"}else 0===b.button?(this._curAoiItem.add(this._getLatLngPoint(b)),this._curAoiItem.render()):2===b.button&&this._onSelectionEnd();this._inRectangular=!1}}.bind(this);this._handleOnContextMenu=function(a){a.preventDefault()}},AOIRenderer});