define(["backbone.marionette","communicator","app","models/MapModel","globals","openlayers","FileSaver"],function(a,b,c,d,e){var f=a.View.extend({model:new d.MapModel,initialize:function(a){this.map=void 0,this.isClosed=!0,this.tileManager=a.tileManager,this.selectionType=null,this.overlay_index=99,this.diffimage_index=this.overlay_index-10,this.diff_overlay=null,this.overlay_layers=[],$(window).resize(function(){this.map&&this.onResize()}.bind(this))},createMap:function(){this.$el.attr("id","map"),this.map=new OpenLayers.Map({div:this.el,fallThrough:!0,tileManager:this.tileManager,controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.Zoom({zoomInId:"zoomIn",zoomOutId:"zoomOut"}),new OpenLayers.Control.Attribution({displayClass:"olControlAttribution"})]}),this.colors=e.objects.get("color"),this.map.events.register("move",this.map,function(a){var b=a.object.getCenter();this.model.set({center:[b.lon,b.lat],zoom:a.object.zoom}),c.isMapPanning=!0}.bind(this)),this.map.events.register("moveend",this.map,function(a){c.isMapPanning=!1,b.mediator.trigger("map:position:change",this.map.getExtent())}.bind(this)),e.baseLayers.each(function(a){var b=this.createLayer(a);b&&this.map.addLayer(b)},this),e.products.each(function(a){var b=this.createLayer(a);b&&this.map.addLayer(b)},this),this.onSortProducts();var a={internalProjection:this.map.baseLayer.projection,externalProjection:new OpenLayers.Projection("EPSG:4326")};this.geojson=new OpenLayers.Format.GeoJSON(a),this.vectorLayer=new OpenLayers.Layer.Vector("vectorLayer"),this.map.addLayers([this.vectorLayer]),this.map.addControl(new OpenLayers.Control.MousePosition),this.drawControls={pointSelection:new OpenLayers.Control.DrawFeature(this.vectorLayer,OpenLayers.Handler.Point),lineSelection:new OpenLayers.Control.DrawFeature(this.vectorLayer,OpenLayers.Handler.Path),polygonSelection:new OpenLayers.Control.DrawFeature(this.vectorLayer,OpenLayers.Handler.Polygon),bboxSelection:new OpenLayers.Control.DrawFeature(this.vectorLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:!0,keyMask:!OpenLayers.Handler.MOD_CTRL}})},e.overlays.each(function(a){var b=this.createLayer(a);b&&(this.map.addLayer(b),this.overlay_layers.push(b))},this);for(var d in this.drawControls)this.map.addControl(this.drawControls[d]),this.drawControls[d].events.register("featureadded",this,this.onDone);var f=e.objects.get("mapmodel");this.map.setCenter(new OpenLayers.LonLat(f.get("center")),f.get("zoom"))},onShow:function(){return this.map||this.createMap(),this.isClosed=!1,this.onResize(),this},onResize:function(){this.map.updateSize()},createLayer:function(a){var c=null,d=a.get("views"),e=void 0;if("undefined"==typeof d)e=a.get("view");else if(1==d.length)e=d[0];else{var f=_.find(d,function(a){return"WMTS"==a.protocol});if(f)e=f;else{var g=_.find(d,function(a){return"WMS"==a.protocol});if(!g)return null;e=g}}switch(e.protocol){case"WMTS":c=new OpenLayers.Layer.WMTS({name:a.get("name"),layer:e.id,protocol:e.protocol,url:e.urls,matrixSet:e.matrixSet,style:e.style,format:e.format,maxExtent:e.maxExtent,resolutions:e.resolutions,projection:e.projection,gutter:e.gutter,buffer:e.buffer,units:e.units,transitionEffect:e.transitionEffect,isphericalMercator:e.isphericalMercator,isBaseLayer:e.isBaseLayer,wrapDateLine:e.wrapDateLine,zoomOffset:e.zoomOffset,visibility:a.get("visible"),time:a.get("time"),attribution:e.attribution});break;case"WMS":c=new OpenLayers.Layer.WMS(a.get("name"),e.urls[0],{layers:e.id,transparent:"true",format:"image/png",time:a.get("time")},{format:"image/png",matrixSet:e.matrixSet,style:e.style,format:e.format,maxExtent:e.maxExtent,resolutions:e.resolutions,projection:e.projection,gutter:e.gutter,buffer:e.buffer,units:e.units,transitionEffect:e.transitionEffect,isphericalMercator:e.isphericalMercator,isBaseLayer:e.isBaseLayer,wrapDateLine:e.wrapDateLine,zoomOffset:e.zoomOffset,visibility:a.get("visible"),attribution:e.attribution});break;default:return null}return c.events.register("loadstart",this,function(){b.mediator.trigger("progress:change",!0)}),c.events.register("loadend",this,function(){b.mediator.trigger("progress:change",!1)}),c},centerMap:function(a){this.map.setCenter(new OpenLayers.LonLat(a.x,a.y),a.l),this.model.set({center:[a.x,a.y],zoom:a.l})},onSortProducts:function(a){e.products.each(function(a){_.each(a.get("views"),function(b){if("WMS"==b.protocol||"WMTS"==b.protocol){var c=this.map.getLayersByName(a.get("name"))[0],d=e.products.length-e.products.indexOf(a);this.map.setLayerIndex(c,d)}},this)},this),console.log("Map products sorted")},onUpdateOpacity:function(a){var b=this.map.getLayersByName(a.model.get("name"))[0];b&&b.setOpacity(a.value)},changeLayer:function(a){if(a.isBaseLayer)this.map.setBaseLayer(this.map.getLayersByName(a.name)[0]);else{var b=this.map.getLayersByName(a.name);b.length&&b[0].setVisibility(a.visible)}},onSelectionActivated:function(a){if(this.selectionType=a.selectionType,a.active)for(key in this.drawControls){var c=this.drawControls[key];a.id==key?c.activate():(c.layer.removeAllFeatures(),c.deactivate(),b.mediator.trigger("selection:changed",null))}else for(key in this.drawControls){var c=this.drawControls[key];c.layer.removeAllFeatures(),c.deactivate(),b.mediator.trigger("selection:changed",null)}},onExportGeoJSON:function(){var a=this.geojson.write(this.vectorLayer.features,!0),b=new Blob([a],{type:"text/plain;charset=utf-8"});saveAs(b,"selection.geojson")},onGetGeoJSON:function(){return this.geojson.write(this.vectorLayer.features,!0)},onGetMapExtent:function(){return this.map.getExtent()},onDone:function(a){var c=this.vectorLayer.features.length;"single"==this.selectionType&&(this.vectorLayer.removeAllFeatures(),c=this.vectorLayer.features.length,b.mediator.trigger("selection:changed",null));var d=this.colors(c);b.mediator.trigger("selection:changed",a.feature,this._convertCoordsFromOpenLayers(a.feature.geometry,0),d),a.feature.destroy()},onSelectionChanged:function(a,b,c){if(a){var d=this.vectorLayer.features.length+1;"single"==this.selectionType&&(this.vectorLayer.removeAllFeatures(),d=this.vectorLayer.features.length),c||(c=this.colors(d)),a.style={fillColor:c,pointRadius:6,strokeColor:c,fillOpacity:.5},this.vectorLayer.addFeatures([a.clone()])}},_convertCoordsFromOpenLayers:function(a,b){for(var c=a.getVertices(),d=[],e=0;e<c.length-1;++e){var f={x:c[e].x,y:c[e].y,z:b};d.push(f)}var f={x:c[e].x,y:c[e].y,z:b};return d.push(f),d},onTimeChange:function(a){var b=getISODateTimeString(a.start)+"/"+getISODateTimeString(a.end);e.products.each(function(a){if(a.get("timeSlider")){a.set("time",b);var c=this.map.getLayersByName(a.get("name"))[0];c.mergeNewParams({time:b})}},this)},onSetExtent:function(a){this.map.zoomToExtent(a)},onClose:function(){this.stopListening(),this.remove(),this.unbind(),this.isClosed=!0},isModelCompatible:function(a){var b=a.get("view").protocol;return"WMS"===b||"WMTS"===b?!0:!1},isEventListenedTo:function(a){return!!this._events[a]},onLoadImage:function(a,b){proj4326=new OpenLayers.Projection("EPSG:4326"),bounds=b,bounds.transform(proj4326,this.map.getProjectionObject()),this.diff_overlay=new OpenLayers.Layer.Image("diff_overlay",a,bounds,new OpenLayers.Size(3400,1600),{isBaseLayer:!1,alwaysInRange:!0}),this.map.addLayer(this.diff_overlay),this.diffimage_index=this.map.getLayerIndex(this.diff_overlay),console.log("image "+this.diffimage_index);var c=9999;_.each(this.overlay_layers,function(a){var b=a.getZIndex();c>b&&(c=b)}.bind(this)),this.diff_overlay.setZIndex(c-1)},onClearImage:function(){this.diff_overlay&&(this.map.removeLayer(this.diff_overlay),this.diff_overlay=null)}});return f});