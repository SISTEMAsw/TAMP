define(["core/BaseView","app","./XTKViewer/Viewer"],function(a,b,c){"use strict";var d=a.extend({className:"sliceview",cacheViewerInstance:!0,initialize:function(b){a.prototype.initialize.call(this,b),this.enableEmptyView(!0),this.currentToI=null,this.currentAoI=null;var c=this.legacyContext().backendConfig.MeshFactory;this.baseURL=c.url+"service=W3DS&request=GetScene&crs=EPSG:4326&version="+c.version,this._setLayersFromAppContext()},onStartup:function(a){},didInsertElement:function(){this.getViewer()||this._setLayersFromAppContext(),this.listenTo(this.legacyContext(),"map:layer:change",this._onLayerChange),this.listenTo(this.legacyContext(),"selection:changed",this._setCurrentAoI),this.listenTo(this.legacyContext(),"time:change",this._onTimeChange)},didRemoveElement:function(){},supportsLayer:function(a){var b=_.find(a.get("views"),function(a){return"w3ds"===a.protocol.toLowerCase()&&"volumetric"===a.type.toLowerCase()});return b?b:null},onResize:function(){this.getViewer()&&this.getViewer().onResize()},onLayerAdd:function(a,b,c){_.forEach(c,function(a){console.log("[SliceView::onLayerAdd] adding: "+a.id),this._addVolume(a.id)}.bind(this))},onLayerRemove:function(a,b,c){_.forEach(c,function(a){console.log("[SliceView::onLayerRemove] removing: "+a.id),this._removeVolume(a.id)}.bind(this))},showEmptyView:function(){this.$el.html('<div class="empty-view">Please select an Area of Interest (AoI) in one of the map viewer!</div>')},hideEmptyView:function(){this.$el.html("")},_setCurrentAoI:function(a){if(a){this.currentAoI=a.geometry.getBounds().toString();var b=this.currentToI;if(!b){var c=new Date(this.legacyContext().timeOfInterest.start),d=new Date(this.legacyContext().timeOfInterest.end);b=this.currentToI=c.toISOString()+"/"+d.toISOString()}}else this.currentToI=null;this._update()},_onTimeChange:function(a){var b=new Date(a.start),c=new Date(a.end);this.currentToI=b.toISOString()+"/"+c.toISOString(),this._update()},_update:function(){this.getViewer()&&this.getViewer().reset(),null!=this.currentAoI&&null!=this.currentToI&&_.forEach(this.selectedLayers(),function(a,b){var c=this.supportsLayer(a.model);c&&(this._addVolume(c.id),console.log("[SliceView::_udpate] added layer: "+c.id))}.bind(this))},_createViewer:function(){return new c({elem:this.el,backgroundColor:[.005,.005,.005],cameraPosition:[500,0,500]})},_addVolume:function(a){this.enableEmptyView(!1),this.onShow();var b=this.baseURL;b+="&boundingBox="+this.currentAoI,b+="&time="+this.currentToI,b+="&layer="+a,b+="&format=model/nii-gz",this.getViewer()||this.setViewer(this._createViewer()),K3D.load(b,function(b,c){this.getViewer().addVolume({filename:a,data:b,isMultiPart:c,label:a,volumeRendering:!0,upperThreshold:219,opacity:.3,minColor:[.4,.4,.4],maxColor:[0,0,0],reslicing:!1})}.bind(this))},_removeVolume:function(a){this.getViewer().removeObject(a)},onClose:function(){this.getViewer()&&this.getViewer().reset(),this.stopListening(),this.remove(),this.unbind(),this.isClosed=!0}});return d});